<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Carosello Brand PRO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- VARIABILI BRAND --- */
        :root {
            --brand-blue: #0146bc;
            --brand-yellow: #eddc01;
            --brand-dark: #222222;
            --brand-light: #ffffff;
            
            --colore-sfondo-ui: #f4f7fa;
            --colore-bordo-ui: #d8dee4;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--colore-sfondo-ui);
            color: var(--brand-dark);
            line-height: 1.6;
        }

        /* --- LAYOUT UI & HEADER --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

        header {
            background-color: var(--brand-blue);
            color: var(--brand-light);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(1, 70, 188, 0.15);
        }
        header h1 { margin: 0; font-size: 1.5rem; }

        /* --- TABS --- */
        .tab-nav { display: flex; border-bottom: 2px solid var(--colore-bordo-ui); margin-bottom: -2px; }
        .tab-button {
            padding: 0.85rem 1.75rem; font-size: 1rem; font-weight: 600; border: none; background: transparent; cursor: pointer; color: #555; border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .tab-button:hover { background: #fff; }
        .tab-button.active { color: var(--brand-blue); border-bottom-color: var(--brand-blue); background: #fff; border-radius: 8px 8px 0 0; }
        .tab-content {
            display: none; background: #fff; padding: 2rem; border-radius: 0 8px 8px 8px; border: 1px solid var(--colore-bordo-ui); border-top: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .tab-content.active { display: block; }

        /* --- INPUTS & CONTROLS --- */
        .section-title {
            color: var(--brand-blue); border-bottom: 3px solid var(--brand-yellow); padding-bottom: 0.5rem; margin-bottom: 1.5rem; font-size: 1.25rem;
        }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #444; font-size: 0.9rem; }
        input[type="text"], textarea, select { width: 100%; padding: 0.75rem; border: 2px solid var(--colore-bordo-ui); border-radius: 8px; font-size: 1rem; font-family: inherit; background: #fff; transition: border 0.2s; }
        input:focus, textarea:focus, select:focus { border-color: var(--brand-blue); outline: none; }
        textarea { resize: vertical; min-height: 120px; }

        .btn { padding: 0.75rem 1.5rem; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.1s, background 0.2s; font-size: 0.95rem; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--brand-blue); color: #fff; }
        .btn-secondary { background: var(--brand-yellow); color: var(--brand-blue); }
        .btn-neutral { background: #f0f0f0; border: 1px solid #ccc; color: #333; }
        .btn-danger { background: #fbeaea; color: #d93025; border: 1px solid #f8d7da; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem; }

        .playground-grid { display: grid; grid-template-columns: 1fr 420px; gap: 2rem; }
        @media (max-width: 1024px) { .playground-grid { grid-template-columns: 1fr; } }

        .preview-area-wrapper { background: #2c2c2c; padding: 2rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 600px; }
        .carousel-preview-container { width: 100%; max-width: 450px; aspect-ratio: 4/5; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        
        /* --- CORE SLIDE STYLES --- */
        .carousel-scroller { width: 100%; height: 100%; background: #fff; overflow: hidden; }
        .carousel-slide {
            width: 100%; height: 100%; padding: 2.5rem; box-sizing: border-box; display: flex; flex-direction: column;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            background-color: var(--colore-sfondo-slide, #fff); position: relative;
        }

        /* --- BLOCCO TESTO & TIPOGRAFIA --- */
        .text-overlay-block {
            width: 100%;
            --local-h1-size: 2.2rem;
            --colore-testo-h1: var(--brand-blue);
            --colore-testo-p: var(--brand-dark);
            --colore-deco: var(--brand-yellow);
        }

        .text-overlay-block h1 { font-size: var(--local-h1-size); color: var(--colore-testo-h1); line-height: 1.1; margin: 0 0 1rem 0; letter-spacing: -0.5px; }
        .text-overlay-block p, .text-overlay-block ul, .text-overlay-block ol { font-size: 1.1rem; color: var(--colore-testo-p); margin: 0 0 1rem 0; }
        .text-overlay-block strong { color: inherit; font-weight: 800; }
        
        /* DECORAZIONE LATERALE (Barre rientrate) */
        .text-overlay-block blockquote {
            border-left: 8px solid var(--colore-deco); 
            padding-left: 1.5rem; margin: 1.5rem 0;
            font-style: italic; 
            font-weight: 400; 
            color: var(--colore-testo-p);
            background: rgba(255,255,255,0.05); /* LEGGERO SFONDO QUI */
        }
        
        /* STATISTICA (Big Number) */
        .big-stat {
            font-size: 6rem; font-weight: 900; line-height: 1;
            color: var(--colore-deco);
            display: block; margin-bottom: 0.5rem;
        }
        .text-overlay-block[contenteditable="true"]:hover { outline: 2px dashed var(--brand-blue); background: rgba(255,255,255,0.5); cursor: text; }

        /* --- TEMPLATES --- */

        /* 5. QUOTE (Citazione Manager) - REVISIONATO */
        .carousel-slide[data-template="quote"] { justify-content: center; align-items: center; text-align: center; padding: 4rem !important; }
        .carousel-slide[data-template="quote"] .text-overlay-block blockquote {
            /* FIX: Rimuove lo sfondo parziale per evitare discrepanze di colore */
            background: transparent; 
            border: none; 
            padding: 0 2rem; margin: 0; 
            font-size: 1.5rem; 
            font-weight: 400; 
            font-style: italic; line-height: 1.4; color: var(--colore-testo-p); position: relative; display: inline-block;
        }
        .carousel-slide[data-template="quote"] .text-overlay-block blockquote::before { content: "“"; font-family: serif; font-size: 6rem; line-height: 0; position: absolute; top: 0; left: -2rem; color: var(--colore-deco); opacity: 1; }
        .carousel-slide[data-template="quote"] .text-overlay-block blockquote::after { content: "”"; font-family: serif; font-size: 6rem; line-height: 0; position: absolute; bottom: -2rem; right: -2rem; color: var(--colore-deco); opacity: 1; }
        .carousel-slide[data-template="quote"] footer { margin-top: 2.5rem; display: flex; flex-direction: column; align-items: center; position: relative; }
        .carousel-slide[data-template="quote"] footer::before { content: ""; width: 50px; height: 3px; background-color: var(--colore-deco); margin-bottom: 1rem; }
        .carousel-slide[data-template="quote"] footer strong { display: block; font-size: 1.2rem; color: var(--colore-testo-h1); font-weight: 800; }
        .carousel-slide[data-template="quote"] footer span { display: block; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-top: 0.2rem; color: var(--colore-testo-p); }
        .carousel-slide[data-template="quote"] .text-overlay-block h1 { font-size: 1.1rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.7; margin-bottom: 2rem; }
        
        /* ALTRI TEMPLATE (CSS omesso per brevità, resta invariato) */
        .carousel-slide[data-template="full"] { justify-content: center; }
        .carousel-slide[data-template="card"] { padding: 3rem; justify-content: center; align-items: center; background-color: #e0e0e0; }
        .carousel-slide[data-template="card"] .text-overlay-block { background-color: #ffffff; padding: 2.5rem; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); --colore-testo-p: #333 !important; }
        .carousel-slide[data-template="split-up"] { background-size: 100% 50% !important; background-position: top center !important; justify-content: flex-end !important; padding: 0 !important; }
        .carousel-slide[data-template="split-down"] { background-size: 100% 50% !important; background-position: bottom center !important; justify-content: flex-start !important; padding: 0 !important; }
        .carousel-slide[data-template="split-up"] .text-overlay-block, .carousel-slide[data-template="split-down"] .text-overlay-block { height: 50%; width: 100%; padding: 2.5rem; display: flex; flex-direction: column; justify-content: center; background: var(--colore-sfondo-slide); }
        .carousel-slide[data-template="img-left"] { background-size: 50% 100% !important; background-position: left center !important; padding: 0 !important; align-items: flex-end; }
        .carousel-slide[data-template="img-left"] .text-overlay-block { width: 50%; margin-left: 50%; height: 100%; padding: 2.5rem; display: flex; flex-direction: column; justify-content: center; background: var(--colore-sfondo-slide); }
        .carousel-slide[data-template="img-right"] { background-size: 50% 100% !important; background-position: right center !important; padding: 0 !important; }
        .carousel-slide[data-template="img-right"] .text-overlay-block { width: 50%; height: 100%; padding: 2.5rem; display: flex; flex-direction: column; justify-content: center; background: var(--colore-sfondo-slide); }
        .carousel-slide[data-template="stat"] { justify-content: center; text-align: center; }
        .carousel-slide[data-template="list"] .text-overlay-block ul { list-style: none; padding: 0; }
        .carousel-slide[data-template="list"] .text-overlay-block li { margin-bottom: 1rem; padding-left: 2rem; position: relative; }
        .carousel-slide[data-template="list"] .text-overlay-block li::before { content: "•"; color: var(--colore-deco); font-size: 2.5rem; line-height: 0; position: absolute; left: 0; top: 0.5rem; }


        /* --- NUOVI STILI RICH TEXT (UI) --- */
        .editor-toolbar {
            display: flex; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ccc; border-radius: 8px; background: #fff; flex-wrap: wrap;
        }
        .editor-toolbar button, .editor-toolbar select {
            padding: 0.4rem 0.6rem; font-size: 0.9rem; border: 1px solid #ddd; background: #f9f9f9; border-radius: 4px; cursor: pointer; transition: background 0.1s;
        }
        .editor-toolbar button:hover { background: #e0e0e0; }
        .editor-toolbar select { width: 100px; }
        .editor-toolbar .color-preview { width: 15px; height: 15px; border-radius: 50%; display: inline-block; margin-right: 5px; border: 1px solid #ccc; vertical-align: middle; }


        /* --- STAMPA PDF --- (Stili omessi per brevità, sono nel codice finale) */
        @media print {
            body * { visibility: hidden; }
            #print-container, #print-container * { visibility: visible; }
            #print-container { position: absolute; top: 0; left: 0; width: 100%; }
            @page { margin: 1cm; size: A4; }
            
            .print-row { display: flex; gap: 2rem; margin-bottom: 2rem; page-break-inside: avoid; border-bottom: 1px solid #eee; padding-bottom: 2rem; }
            .print-visual { width: 300px; height: 375px; border: 1px solid #ddd; position: relative; overflow: hidden; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            .print-visual .carousel-slide { padding: 1.5rem !important; }
            
            .print-visual .carousel-slide[data-template="img-left"], .print-visual .carousel-slide[data-template="img-right"] { background-size: 50% 100% !important; -webkit-print-color-adjust: exact;}
            
            .print-visual h1 { font-size: 1.4rem !important; }
            .print-visual p { font-size: 0.9rem !important; }
            .print-visual .big-stat { font-size: 3rem !important; }

            .print-info { flex: 1; font-size: 14px; color: #000; font-family: monospace;}
            .print-header { font-size: 1.5rem; color: var(--brand-blue); border-bottom: 2px solid var(--brand-dark); margin-bottom: 1rem; padding-bottom: 0.5rem; }
            .print-copy { white-space: pre-wrap; font-family: monospace; background: #f4f4f4; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Generatore Carosello Brand PRO</h1>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" onclick="switchTab('generator')">1. Generatore Prompt</button>
            <button class="tab-button" onclick="switchTab('playground')">2. Playground & Export</button>
        </nav>

        <div id="tab-generator" class="tab-content active">
            <h2 class="section-title">Dati per l'AI</h2>
            <div class="form-group">
                <label>Argomento del Post</label>
                <input type="text" id="inp-argomento" placeholder="Es. I vantaggi del nostro servizio premium">
            </div>
            <div class="form-group">
                <label>Contenuto Grezzo / Appunti</label>
                <textarea id="inp-contenuto" placeholder="Incolla qui il testo, la dichiarazione del manager o i punti chiave..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="generatePrompt()">Genera Prompt</button>
            
            <div id="prompt-result" style="display:none; margin-top: 2rem;">
                <h3>Prompt Pronto</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:0.5rem;">Copia e incolla in ChatGPT/Gemini:</p>
                <textarea id="out-prompt" readonly></textarea>
                <button class="btn btn-secondary" onclick="copyPrompt()">Copia Prompt</button>
            </div>
        </div>

        <div id="tab-playground" class="tab-content">
            <div class="playground-grid">
                
                <div class="preview-area-wrapper">
                    <div class="carousel-preview-container">
                        <div id="carousel-scroller" class="carousel-scroller">
                            <div class="carousel-slide" style="justify-content: center; align-items: center; text-align: center; color: #888;">
                                <p>Carica un JSON o aggiungi una Slide manuale</p>
                            </div>
                        </div>
                    </div>
                    <div class="carousel-nav">
                        <button class="nav-arrow" id="btn-prev" onclick="moveSlide(-1)" disabled>&larr;</button>
                        <span id="lbl-pager" style="color: #fff; font-weight:600;">0 / 0</span>
                        <button class="nav-arrow" id="btn-next" onclick="moveSlide(1)" disabled>&rarr;</button>
                    </div>
                </div>

                <div class="controls-area">
                    <details class="control-group" open>
                        <summary>Input JSON</summary>
                        <div class="form-group" style="margin-top: 1rem;">
                            <textarea id="json-input" rows="4" placeholder="Incolla qui il JSON..."></textarea>
                        </div>
                        <div class="button-grid">
                            <button class="btn btn-primary" onclick="parseAndRender()">Visualizza</button>
                            <button class="btn btn-neutral" onclick="document.getElementById('file-upload').click()">Importa</button>
                        </div>
                        <input type="file" id="file-upload" style="display:none" accept=".json" onchange="importJsonFile(event)">
                    </details>

                    <div id="visual-controls" style="display:none;">
                        
                        <div class="control-group">
                            <summary>Formattazione Testo Selezionato</summary>
                            <div id="editor-toolbar" class="editor-toolbar">
                                <button onclick="formatText('bold')"><b>Grassetto</b></button>
                                <button onclick="formatText('italic')"><i>Corsivo</i></button>
                                <button onclick="formatText('removeFormat')">Normale</button>
                                
                                <select id="color-selector" onchange="formatText('foreColor', this.value)" style="flex-grow: 1;">
                                    <option value="" disabled selected>Colore Selezionato...</option>
                                    <option value="#000000"><span class="color-preview" style="background:#000;"></span>Nero</option>
                                    <option value="#0146bc"><span class="color-preview" style="background:#0146bc;"></span>Blu Brand</option>
                                    <option value="#eddc01"><span class="color-preview" style="background:#eddc01;"></span>Giallo Brand</option>
                                    <option value="#d93025"><span class="color-preview" style="background:#d93025;"></span>Rosso (Errore)</option>
                                </select>
                            </div>
                            <small style="display: block; color: #888; margin-top: -0.5rem;">* Seleziona il testo nell'anteprima per applicare.</small>
                        </div>
                        
                        <details class="control-group" open>
                            <summary>Layout & Template</summary>
                            <div class="template-grid">
                                <button class="icon-btn active" data-tpl="full" onclick="setTemplate('full')">Standard Full</button>
                                <button class="icon-btn" data-tpl="card" onclick="setTemplate('card')">Box / Card</button>
                                <button class="icon-btn" data-tpl="img-left" onclick="setTemplate('img-left')">Img SX / Testo DX</button>
                                <button class="icon-btn" data-tpl="img-right" onclick="setTemplate('img-right')">Img DX / Testo SX</button>
                                <button class="icon-btn" data-tpl="split-up" onclick="setTemplate('split-up')">Split (Img Su)</button>
                                <button class="icon-btn" data-tpl="split-down" onclick="setTemplate('split-down')">Split (Img Giù)</button>
                                <button class="icon-btn" data-tpl="quote" onclick="setTemplate('quote')">Citazione</button>
                                <button class="icon-btn" data-tpl="stat" onclick="setTemplate('stat')">Statistica Big</button>
                                <button class="icon-btn" data-tpl="list" onclick="setTemplate('list')">Elenco Puntato</button>
                            </div>
                        </details>

                        <details class="control-group" open>
                            <summary>Colori (Tutto Giallo Attivo)</summary>
                            <div style="margin-top: 1rem;">
                                
                                <div class="form-group">
                                    <label>Sfondo Slide</label>
                                    <select id="sel-bg" onchange="updateStyle('bg', this.value)">
                                        <option value="#ffffff">Bianco (Brand Light)</option>
                                        <option value="#222222">Grigio Scuro (Brand Dark)</option>
                                        <option value="#0146bc">Blu Istituzionale</option>
                                        <option value="#eddc01">Giallo Brand</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Testo Corpo (p, li)</label>
                                    <select id="sel-text" onchange="updateStyle('text', this.value)">
                                        <option value="#333333">Nero / Grigio Scuro</option>
                                        <option value="#ffffff">Bianco</option>
                                        <option value="#0146bc">Blu Istituzionale</option>
                                        <option value="#eddc01">Giallo Brand</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Titoli (h1)</label>
                                    <select id="sel-accent" onchange="updateStyle('accent', this.value)">
                                        <option value="#0146bc">Blu Istituzionale</option>
                                        <option value="#eddc01">Giallo Brand</option>
                                        <option value="#ffffff">Bianco</option>
                                        <option value="#222222">Grigio Scuro</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Decorazioni / Bordi / Stat</label>
                                    <select id="sel-deco" onchange="updateStyle('deco', this.value)">
                                        <option value="#eddc01">Giallo Brand</option>
                                        <option value="#0146bc">Blu Istituzionale</option>
                                        <option value="#ffffff">Bianco</option>
                                        <option value="#222222">Grigio Scuro</option>
                                    </select>
                                </div>
                            </div>
                        </details>

                        <details class="control-group">
                            <summary>Immagine</summary>
                            <p id="suggerimento-visual" style="font-size: 0.85rem; background: #fffde7; padding: 0.5rem; margin-top:1rem;">AI: ...</p>
                            <button class="btn btn-neutral" style="width:100%" onclick="document.getElementById('img-upload').click()">Carica Immagine</button>
                            <input type="file" id="img-upload" style="display:none" accept="image/*" onchange="uploadImage(event)">
                            <button class="btn btn-danger" style="width:100%; margin-top:0.5rem;" onclick="removeImage()">Rimuovi</button>
                        </details>

                        <div class="button-grid" style="margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="addSlide()">+ Nuova Slide</button>
                            <button class="btn btn-danger" onclick="removeSlide()">Elimina</button>
                        </div>
                    </div>

                    <div class="control-group" style="margin-top: 1rem;">
                        <label>Esporta</label>
                        <div class="button-grid">
                            <button class="btn btn-neutral" onclick="exportJson()">Salva JSON</button>
                            <button class="btn btn-primary" onclick="exportPdf()">STAMPA PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="print-container"></div>

    <script>
        // --- COSTANTI ---
        const LOREM_TITLE = "Titolo Provvisorio";
        const LOREM_BODY = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin nibh augue, suscipit a, scelerisque sed, lacinia in, mi.";
        
        const BRAND = {
            blue: '#0146bc',
            yellow: '#eddc01',
            dark: '#222222',
            light: '#ffffff',
            textDark: '#333333'
        };

        // Stato Applicazione
        let slidesData = [];
        let currentSlideIdx = 0;
        let copyPost = "";

        // --- GESTIONE FORMATTAZIONE TESTO SELEZIONATO ---
        function formatText(command, value = null) {
            // Applica il comando al testo selezionato nell'area contenteditable
            document.execCommand(command, false, value);
            
            // Re-focus sull'area per permettere di continuare a scrivere
            const currentSlideElement = document.getElementById('carousel-scroller').querySelector('.text-overlay-block');
            if (currentSlideElement) {
                currentSlideElement.focus();
            }
        }
        
        // --- TABS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            const btnIdx = tabName === 'generator' ? 0 : 1;
            document.querySelectorAll('.tab-button')[btnIdx].classList.add('active');
        }

        // --- GENERATORE PROMPT ---
        function generatePrompt() {
            const arg = document.getElementById('inp-argomento').value;
            const txt = document.getElementById('inp-contenuto').value;
            
            const prompt = `
Agisci come Social Media Manager. Crea uno storyboard per un carosello (4-8 slide).
ARGOMENTO: ${arg}
INPUT: ${txt}

ISTRUZIONI FORMATO SLIDE:
1. Usa vari layout (Citazione, Statistica, Img Laterale, Elenco) per variare il ritmo.
2. Per le Citazioni, la struttura HTML obbligatoria è: <blockquote>Testo della citazione</blockquote><footer><strong>Nome Cognome</strong><span>Ruolo Aziendale</span></footer>. Non usare il tag <strong> sul testo della citazione.
3. Per evidenziare concetti, usa il tag <blockquote> per attivare la barra laterale colorata.
4. Per le Statistiche, usa <span class="big-stat">Numero o Percentuale</span>.

OUTPUT JSON (Obbligatorio):
{
  "copy_post": "Testo caption...",
  "slides": [
    {
      "testo_html": "HTML della slide come da istruzioni",
      "suggerimento_visual": "Descrizione immagine...",
      "background_image": null,
      "text_styles": { "colors": {"bg": "#ffffff", "text": "#333333", "accent": "#0146bc", "deco": "#eddc01"}, "template": "full" }
    }
  ]
}
`;
            document.getElementById('out-prompt').value = prompt.trim();
            document.getElementById('prompt-result').style.display = 'block';
        }

        function copyPrompt() {
            navigator.clipboard.writeText(document.getElementById('out-prompt').value);
            alert('Copiato!');
        }

        // --- PARSING & RENDERING ---
        function parseAndRender() {
            try {
                const jsonStr = document.getElementById('json-input').value;
                const data = JSON.parse(jsonStr);
                if(!data.slides) throw new Error("JSON non valido");

                copyPost = data.copy_post || "";
                slidesData = data.slides.map(s => ({
                    html: s.testo_html || `<h1>${LOREM_TITLE}</h1><p>${LOREM_BODY}</p>`,
                    visualDesc: s.suggerimento_visual || "",
                    bgImage: s.background_image || null,
                    styles: s.text_styles || { 
                        colors: { bg: BRAND.light, text: BRAND.textDark, accent: BRAND.blue, deco: BRAND.yellow }, 
                        template: 'full' 
                    }
                }));

                currentSlideIdx = 0;
                document.getElementById('visual-controls').style.display = 'block';
                renderCurrentSlide();
            } catch(e) {
                alert("Errore JSON: " + e.message);
            }
        }

        function createSlideDOM(slideData) {
            const wrapper = document.createElement('div');
            wrapper.className = 'carousel-slide';
            
            let tpl = slideData.styles.template || 'full';
            wrapper.setAttribute('data-template', tpl);

            if(slideData.bgImage) wrapper.style.backgroundImage = `url(${slideData.bgImage})`;

            // Applicazione Colori CSS
            const c = slideData.styles.colors || { bg: BRAND.light, text: BRAND.textDark, accent: BRAND.blue, deco: BRAND.yellow };
            wrapper.style.setProperty('--colore-sfondo-slide', c.bg);

            const textBlock = document.createElement('div');
            textBlock.className = 'text-overlay-block';
            textBlock.innerHTML = slideData.html;
            textBlock.contentEditable = true;

            // Listener update html
            textBlock.addEventListener('input', function() { slidesData[currentSlideIdx].html = this.innerHTML; });

            // Mapping variabili CSS
            textBlock.style.setProperty('--colore-testo-h1', c.accent);
            textBlock.style.setProperty('--colore-testo-p', c.text);
            textBlock.style.setProperty('--colore-deco', c.deco);

            wrapper.appendChild(textBlock);
            return wrapper;
        }

        function renderCurrentSlide() {
            const scroller = document.getElementById('carousel-scroller');
            scroller.innerHTML = '';
            if(slidesData.length === 0) return;

            const slide = slidesData[currentSlideIdx];
            const domEl = createSlideDOM(slide);
            scroller.appendChild(domEl);

            // Update UI
            document.getElementById('lbl-pager').innerText = `${currentSlideIdx + 1} / ${slidesData.length}`;
            document.getElementById('btn-prev').disabled = currentSlideIdx === 0;
            document.getElementById('btn-next').disabled = currentSlideIdx === slidesData.length - 1;
            document.getElementById('suggerimento-visual').innerText = "Visual AI: " + (slide.visualDesc || "Nessuno");

            // Sync Selectors
            const c = slide.styles.colors || { bg: BRAND.light, text: BRAND.textDark, accent: BRAND.blue, deco: BRAND.yellow };
            const tpl = slide.styles.template || 'full';
            
            const setSelect = (id, val) => {
                const el = document.getElementById(id);
                if(el.querySelector(`option[value='${val}']`)) el.value = val;
            };

            setSelect('sel-bg', c.bg);
            setSelect('sel-text', c.text);
            setSelect('sel-accent', c.accent);
            setSelect('sel-deco', c.deco);

            // Highlight template btn
            document.querySelectorAll('.template-grid .icon-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.tpl === tpl);
            });
        }

        // --- AZIONI MODIFICA ---
        function moveSlide(dir) { currentSlideIdx += dir; renderCurrentSlide(); }

        function setTemplate(tpl) {
            if(!slidesData[currentSlideIdx].styles) slidesData[currentSlideIdx].styles = {};
            slidesData[currentSlideIdx].styles.template = tpl;
            
            let currentHtml = slidesData[currentSlideIdx].html;

            // Logica di auto-inserimento HTML in base al template
            if(tpl === 'stat' && !currentHtml.includes('big-stat')) {
                 slidesData[currentSlideIdx].html = `<h1>Statistica</h1><span class="big-stat">85%</span><p>Di Risparmio</p>`;
            }
            if(tpl === 'quote' && !currentHtml.includes('<footer>')) {
                const quoteContent = currentHtml.includes('blockquote') ? currentHtml.match(/<blockquote>(.*?)<\/blockquote>/s)[0] : `<blockquote>${LOREM_BODY}</blockquote>`;
                slidesData[currentSlideIdx].html = `<h1>Citazione Leader</h1>${quoteContent}<footer><strong>Nome Cognome</strong><span>Ruolo Aziendale</span></footer>`;
            }
            if(tpl === 'list' && !currentHtml.includes('<ul>')) {
                 slidesData[currentSlideIdx].html = `<h1>Punti Chiave</h1><ul><li>Punto uno</li><li>Punto due</li><li>Punto tre</li></ul>`;
            }

            renderCurrentSlide();
        }

        function updateStyle(prop, val) {
            if(!slidesData[currentSlideIdx].styles) slidesData[currentSlideIdx].styles = {};
            if(!slidesData[currentSlideIdx].styles.colors) slidesData[currentSlideIdx].styles.colors = {};
            
            slidesData[currentSlideIdx].styles.colors[prop] = val;
            renderCurrentSlide();
        }

        function uploadImage(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                slidesData[currentSlideIdx].bgImage = evt.target.result;
                renderCurrentSlide();
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        function removeImage() {
            slidesData[currentSlideIdx].bgImage = null;
            renderCurrentSlide();
        }

        // --- AGGIUNTA SLIDE CON LOREM IPSUM ---
        function addSlide() {
            const loremHtml = `
                <h1>${LOREM_TITLE}</h1>
                <p>${LOREM_BODY}</p>
                <blockquote>Punto chiave evidenziato con barra laterale.</blockquote>
            `;
            
            slidesData.splice(currentSlideIdx + 1, 0, {
                html: loremHtml,
                visualDesc: "Nuova slide generata manualmente con Lorem Ipsum",
                styles: { 
                    template: 'full', 
                    colors: { bg: BRAND.light, text: BRAND.textDark, accent: BRAND.blue, deco: BRAND.yellow } 
                }
            });
            currentSlideIdx++;
            renderCurrentSlide();
        }

        function removeSlide() {
            if(slidesData.length <= 1) return;
            if(!confirm("Eliminare slide?")) return;
            slidesData.splice(currentSlideIdx, 1);
            if(currentSlideIdx >= slidesData.length) currentSlideIdx = slidesData.length - 1;
            renderCurrentSlide();
        }

        // --- EXPORT ---
        function exportJson() {
            const data = { copy_post: copyPost, slides: slidesData };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'brand-carousel.json';
            a.click();
        }

        function importJsonFile(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                document.getElementById('json-input').value = evt.target.result;
                parseAndRender();
            };
            reader.readAsText(file);
        }

        function exportPdf() {
            const container = document.getElementById('print-container');
            container.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'print-header';
            header.innerHTML = 'Storyboard Brand';
            container.appendChild(header);

            const copyBox = document.createElement('div');
            copyBox.className = 'print-copy';
            copyBox.innerText = copyPost;
            container.appendChild(copyBox);

            slidesData.forEach((slide, idx) => {
                const row = document.createElement('div');
                row.className = 'print-row';

                const visual = document.createElement('div');
                visual.className = 'print-visual';
                
                const domClone = createSlideDOM(slide);
                domClone.querySelector('.text-overlay-block').contentEditable = false;
                visual.appendChild(domClone);

                const info = document.createElement('div');
                info.className = 'print-info';
                info.innerHTML = `<strong>Slide ${idx+1}</strong><br>Template: ${slide.styles.template}<br><br>Suggerimento AI:<br>${slide.visualDesc}`;

                row.appendChild(visual);
                row.appendChild(info);
                container.appendChild(row);
            });

            window.print();
        }
    </script>
</body>
</html>
