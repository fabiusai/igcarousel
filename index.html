<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Prompt Carosello</title>
    <link rel="icon" href="favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">


    <style>
        /* Stile Globale e Variabili Colore */
        :root {
            --colore-primario: #0146bc; /* Blu */
            --colore-secondario: #eddc01; /* Giallo */
            --colore-testo: #333;
            --colore-testo-chiaro: #ffffff;
            --colore-sfondo: #f4f7fa;
            --colore-bordo: #d8dee4;
            --colore-neutro-chiaro: #f9f9f9;
            --colore-neutro-scuro: #555;
            --colore-errore: #d93025;
            
            /* NUOVA var Grigio Scuro per Sfondi/Testi */
            --colore-grigio-scuro: #222;
        }

        /* --- STILI TEMA RIMOSSI --- */
        /* La stilizzazione ora è granulare e applicata via JS */


        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            background-color: var(--colore-sfondo);
            color: var(--colore-testo);
            line-height: 1.6;
        }
        
        /* Contenitore Principale */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header */
        header {
            background-color: var(--colore-primario);
            color: var(--colore-testo-chiaro);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        header h1 {
            margin: 0;
            font-size: 1.75rem;
            text-align: center;
        }

        /* Navigazione Tab */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid var(--colore-bordo);
            margin-bottom: -2px; /* Sovrapposizione per la linea attiva */
            z-index: 1;
            position: relative;
        }

        .tab-button {
            padding: 0.85rem 1.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            background-color: transparent;
            cursor: pointer;
            color: var(--colore-neutro-scuro);
            border-radius: 8px 8px 0 0;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            background-color: var(--colore-neutro-chiaro);
        }

        .tab-button.active {
            color: var(--colore-primario);
            border-bottom: 3px solid var(--colore-primario);
            background-color: var(--colore-testo-chiaro);
        }

        /* Contenuto Tab */
        .tab-content {
            display: none;
            background-color: var(--colore-testo-chiaro);
            padding: 2.5rem;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--colore-bordo);
            border-top: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Sezioni Interne */
        .section {
            margin-bottom: 2.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--colore-primario);
            border-bottom: 3px solid var(--colore-secondario);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* Elementi Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--colore-neutro-scuro);
        }

        input[type="text"],
        input[type="number"], 
        input[type="range"],
        select,
        textarea {
            width: 100%;
            padding: 0.85rem;
            font-size: 1rem;
            border: 2px solid var(--colore-bordo);
            border-radius: 8px;
            box-sizing: border-box; 
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #fff; /* Aggiunto per coerenza select */
        }
        
        input[type="range"] {
            padding: 0.25rem;
        }

        input[type="text"]:focus,
        input[type="number"]:focus, 
        input[type="range"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--colore-primario);
            box-shadow: 0 0 0 3px rgba(1, 70, 188, 0.2);
        }

        textarea {
            min-height: 180px;
            resize: vertical;
        }

        /* Checkbox (usato per Tema e per Generatore) */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .checkbox-group:hover {
            background-color: var(--colore-neutro-chiaro);
        }
        
        input[type="checkbox"] {
            width: 1.25em;
            height: 1.25em;
            accent-color: var(--colore-primario);
            cursor: pointer;
        }
        .checkbox-group label {
            margin-bottom: 0; /* Override */
            cursor: pointer;
        }


        /* Bottoni */
        .btn {
            padding: 0.85rem 1.75rem;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 150px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--colore-primario);
            color: var(--colore-testo-chiaro);
        }

        .btn-primary:hover {
            background-color: #00338a; /* Blu più scuro */
        }

        .btn-secondary {
            background-color: var(--colore-secondario);
            color: var(--colore-primario);
            border: 2px solid var(--colore-secondario);
        }

        .btn-secondary:hover {
            background-color: #d4c400; /* Giallo più scuro */
            border-color: #d4c400;
        }

        /* Stile per bottoni "neutri" (grigi) */
        .btn-neutral {
            background-color: #f0f0f0; /* Grigio chiaro */
            color: #333;
            border: 2px solid #dcdcdc;
        }

        .btn-neutral:hover {
            background-color: #e0e0e0;
            border-color: #ccc;
        }

        /* Titoli per sottosezioni nel playground */
        .subsection-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--colore-neutro-scuro);
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--colore-bordo);
            padding-bottom: 0.25rem;
        }

        .btn-danger {
            background-color: var(--colore-errore);
            color: var(--colore-testo-chiaro);
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            min-width: auto;
        }

        /* Area Link Dinamici */
        .link-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .link-item input {
            flex-grow: 1;
        }

        /* Area Output Prompt */
        #prompt-output-container {
            margin-top: 1.5rem;
        }

        #prompt-output {
            min-height: 250px;
            background-color: var(--colore-neutro-chiaro);
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* --- STILI PLAYGROUND --- */

        .playground-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2.5rem;
        }

        @media (min-width: 1024px) {
            .playground-grid {
                grid-template-columns: 1fr minmax(400px, 450px);
            }
        }
        
        .playground-col-preview {
            width: 100%;
        }

        /* --- INIZIO MODIFICHE UI PREVIEW --- */
        .preview-area-wrapper {
            background-color: #333; /* Sfondo omogeneo scuro */
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            min-height: 700px; 
        }


        /* Stile Carousel Preview */
        .carousel-preview-container {
            position: relative;
            width: 100%;
            max-width: 500px; 
            margin: 0;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }
        
        .carousel-scroller {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; 
            
            /* --- VARIABILI GLOBALI TESTO --- */
            --global-font-size-multiplier: 1;
            --global-line-height: 1.6;
            --global-letter-spacing: 0px;

            border-radius: 0;
        }

        .carousel-slide {
            flex: 0 0 100%;
            width: 100%;
            aspect-ratio: 4 / 5;
            scroll-snap-align: start;
            padding: 1.75rem;
            box-sizing: border-box;
            
            /* Default, ma controllato da JS via applyLayout() */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            
            overflow: auto; 
            position: relative; 
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            
            border-right: none;
            border-radius: 0;
            
            /* Colori di default, ora sovrascritti da JS */
            background-color: var(--colore-testo-chiaro); 
            /* Variabili colore testo (saranno nel text-overlay-block) */
            --colore-testo-h1: var(--colore-primario);
            --colore-testo-p: var(--colore-testo);
            --colore-testo-small: var(--colore-neutro-scuro);
            --colore-testo-strong: var(--colore-primario);
            --colore-blockquote-border: var(--colore-secondario);
            --colore-blockquote-text: var(--colore-neutro-scuro);
        }
                
        .carousel-slide:last-child {
            border-right: none;
        }

        .carousel-nav {
            display: flex;
            justify-content: space-between;
            background-color: transparent;
            border-top: none;
            padding: 1rem 0;
            width: 100%;
            max-width: 500px; /* Allineato al carousel */
        }
        
        #carousel-pager {
            align-self: center; 
            color: var(--colore-testo-chiaro); /* Testo bianco */
            font-weight: 600;
        }
        /* --- FINE MODIFICHE UI PREVIEW --- */


        .carousel-nav-btn {
            background: var(--colore-primario);
            color: var(--colore-testo-chiaro);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .carousel-nav-btn:hover {
            background-color: #00338a;
        }

        .carousel-nav-btn:disabled {
            background-color: var(--colore-bordo);
            cursor: not-allowed;
        }

        /* Stile Testi Slide (ora usa VARIABILI) */
        .text-overlay-block {
            width: 90%; 
            max-width: 90%; 
            box-sizing: border-box;
            
            /* Stili globali applicati qui */
            line-height: var(--global-line-height);
            letter-spacing: var(--global-letter-spacing);
        }

        /* --- INIZIO CORREZIONE CSS --- */
        .text-overlay-block h1 {
            font-size: calc(var(--local-h1-size, 2rem) * var(--global-font-size-multiplier));
            color: var(--colore-testo-h1);
            margin: 0 0 calc(1rem * var(--global-line-height, 1.6)) 0;
            /* MODIFICA: Forzato il line-height per essere controllato dallo slider */
            line-height: var(--global-line-height);
        }
        .text-overlay-block p {
            font-size: calc(var(--local-p-size, 1.1rem) * var(--global-font-size-multiplier));
            margin: calc(0.5rem * var(--global-line-height, 1.6)) 0;
            color: var(--colore-testo-p);
        }
        .text-overlay-block strong {
            color: var(--colore-testo-strong);
            font-weight: 700;
        }
        .text-overlay-block blockquote {
            border-left: 4px solid var(--colore-blockquote-border);
            padding-left: 1.25rem;
            margin: calc(1rem * var(--global-line-height, 1.6)) 0;
            font-style: italic;
            font-size: calc(var(--local-p-size, 1.1rem) * var(--global-font-size-multiplier)); /* Usa stessa size di P */
            color: var(--colore-blockquote-text);
        }
        
        /* --- NUOVO CSS PER FOOTER CITAZIONI --- */
        .text-overlay-block blockquote footer {
            margin-top: 0.75rem;
            font-style: normal;
            font-size: calc(0.9 * var(--local-p-size, 1.1rem) * var(--global-font-size-multiplier)); /* 90% di P */
            text-align: right;
            line-height: 1.4; /* Interlinea fissa per footer */
        }
        .text-overlay-block blockquote .nome {
            display: block;
            font-weight: 700;
            color: var(--colore-testo-strong); /* Usa il colore strong */
        }
        .text-overlay-block blockquote .ruolo {
            display: block;
            font-size: 0.9em; /* 90% del footer */
            opacity: 0.8;
            color: var(--colore-testo-p); /* Usa il colore p */
        }
        /* --- FINE NUOVO CSS --- */

        .text-overlay-block small {
            font-size: calc(var(--local-small-size, 0.85rem) * var(--global-font-size-multiplier));
            color: var(--colore-testo-small);
            opacity: 0.9;
            display: block;
            margin-top: calc(1rem * var(--global-line-height, 1.6));
        }
        /* --- FINE CORREZIONE CSS --- */


        /* Sezioni Output Playground (Suggerimenti e Copy) */
        .playground-output-box {
            margin-top: 1.5rem;
            border: 2px solid var(--colore-bordo);
            border-radius: 8px;
        }

        .playground-output-box h3 {
            font-size: 1.1rem;
            margin: 0;
            padding: 0.75rem 1rem;
            background-color: var(--colore-neutro-chiaro);
            border-bottom: 2px solid var(--colore-bordo);
            color: var(--colore-primario);
        }

        .playground-output-content {
            padding: 1rem;
            min-height: 100px;
            background-color: var(--colore-testo-chiaro);
            border-radius: 0 0 6px 6px;
        }

        /* Area per feedback e elementi modificabili */
        #json-error {
            color: var(--colore-errore);
            font-weight: 600;
            display: none;
            margin-top: 0.5rem;
        }
        
        .text-overlay-block[contenteditable="true"] {
            outline: 2px dashed transparent;
            transition: outline 0.2s ease;
            padding: 0.5rem; 
            border-radius: 4px;
        }

        /* Outline modificata per funzionare su sfondi diversi */
        .text-overlay-block[contenteditable="true"]:hover,
        .text-overlay-block[contenteditable="true"]:focus-within {
            outline: 2px dashed var(--colore-primario);
            background-color: rgba(0, 0, 0, 0.1); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        

        /* Griglia Stili Granulari (Ora solo Dimensione) */
        .style-grid {
            display: grid;
            grid-template-columns: auto 1fr; /* Label, Dimensione (rem) */
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .style-grid label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--colore-neutro-scuro);
        }
        .style-grid input[type="number"] {
            padding: 0.5rem; /* Ridotto per griglia */
            font-size: 0.9rem;
            margin: 0;
        }
        
        /* Griglia Stili Globali */
        .global-style-grid {
            display: grid;
            grid-template-columns: auto 1fr auto; /* Label, Range, Valore */
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .global-style-grid label {
             font-weight: 600;
            font-size: 0.9rem;
            color: var(--colore-neutro-scuro);
            margin-bottom: 0;
        }
        .global-style-grid span {
            font-family: monospace;
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 45px;
            text-align: right;
        }

        /* --- STILI CUSTOM ALERT MODAL --- */
        .alert-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s;
        }
        .alert-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .alert-modal-box {
            background: var(--colore-testo-chiaro);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }
        .alert-modal-overlay.visible .alert-modal-box {
            transform: scale(1);
        }
        .alert-modal-box p {
            margin: 0 0 1.5rem 0;
            font-size: 1.1rem;
            color: var(--colore-testo);
        }
        /* --- Fine STILI CUSTOM ALERT MODAL --- */


        /* --- NUOVI STILI PER ACCORDION E LAYOUT --- */
        .control-group summary {
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--colore-primario);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--colore-bordo);
            padding-bottom: 0.25rem;
            user-select: none; /* Impedisce la selezione del testo */
        }

        .control-group summary:hover {
            color: #00338a;
        }

        .control-group > *:not(summary) {
            margin-left: 0.5rem; /* Indenta leggermente il contenuto */
            margin-right: 0.5rem;
        }

        /* Nasconde il marcatore di default e ne mette uno custom */
        .control-group summary {
          list-style: none;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .control-group summary::-webkit-details-marker {
          display: none;
        }
        .control-group summary::after {
          content: '▼';
          font-size: 0.8rem;
          transition: transform 0.2s ease;
        }
        .control-group[open] summary::after {
          transform: rotate(180deg);
        }

        /* Griglia Layout */
        .layout-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .layout-btn {
            padding: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            border: 2px solid var(--colore-bordo);
            border-radius: 8px;
            background: var(--colore-testo-chiaro);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .layout-btn:hover {
            background: var(--colore-neutro-chiaro);
        }
        .layout-btn.active {
            background: var(--colore-primario);
            color: var(--colore-testo-chiaro);
            border-color: var(--colore-primario);
        }
        
        /* NUOVO: Griglia Colori */
         .color-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .color-grid label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--colore-neutro-scuro);
        }
        .color-grid select {
            padding: 0.5rem; /* Ridotto */
            font-size: 0.9rem;
            background-color: #fff;
            border: 2px solid var(--colore-bordo);
        }
        
        /* --- FINE NUOVI STILI --- */


        /* --- STILI DI STAMPA PER PDF --- */
        @media print {
            body * {
                visibility: hidden;
            }

            #tab-playground, #tab-playground * {
                visibility: visible;
            }

            header, .tab-nav, #tab-generator, 
            .playground-col-controls label, #json-input, 
            #btn-export-pdf, 
            .carousel-nav, #suggerimenti-output, 
            .playground-output-box h3:first-child,
            #btn-upload-bg, #image-uploader,
            .subsection-title,
            .form-group, /* Nasconde vecchi form-group */
            .style-grid, /* Nasconde nuova griglia stili locali */
            .global-style-grid, /* Nasconde griglia stili globali */
            #btn-apply-styles, /* Nasconde nuovo bottone locali */
            #btn-apply-global-styles, /* Nasconde bottone globali */
            .color-grid, /* Nasconde griglia colori */
            .preview-area-wrapper, /* Nasconde wrapper scuro */
            
            /* NASCONDE NUOVI CONTROLLI */
            .control-group summary, /* Nasconde titoli accordion */
            .layout-controls, /* Nasconde griglia layout */
            #btn-add-slide, #btn-delete-slide /* Nasconde bottoni add/remove */
            {
                display: none !important;
            }

            body {
                background-color: #ffffff;
                margin: 0;
                padding: 0;
            }

            #tab-playground {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1rem;
                box-shadow: none;
                border: none;
            }

            .playground-grid {
                display: block;
            }

            .carousel-scroller {
                display: block;
                overflow: visible;
                height: auto;
            }

            .carousel-slide {
                display: flex !important; /* Forza flex per allineamento stampa */
                width: 90%; 
                margin: 0 auto;
                height: auto;
                aspect-ratio: unset; 
                padding: 1.5rem;
                border: 2px solid var(--colore-bordo);
                box-shadow: none;
                page-break-after: always; 
                
                background-size: cover !important;
                background-position: center !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                
                /* Forza colori di stampa */
                background-color: #fff !important;
                --colore-testo-h1: #000 !important;
                --colore-testo-p: #000 !important;
                --colore-testo-small: #000 !important;
                --colore-testo-strong: #000 !important;
                --colore-blockquote-border: #ccc !important;
                --colore-blockquote-text: #000 !important;
            }
            
            .text-overlay-block {
                position: relative !important; 
                top: auto !important;
                left: auto !importan.carousel-preview-containert;
                width: 100% !important;
            }
            /* Forza stili leggibili per la stampa (ignora tema) */
            .text-overlay-block, .text-overlay-block * {
                color: #000 !important;
                background: transparent !important;
                line-height: 1.5 !important;
                letter-spacing: normal !important;
            }
            /* Forza font-size specifici per stampa se necessario */
            .text-overlay-block h1 { font-size: 24pt !important; }
            .text-overlay-block p { font-size: 11pt !important; }
            .text-overlay-block small { font-size: 8pt !important; }


            .carousel-slide:last-child {
                page-break-after: auto;
            }

            .playground-output-box, 
            #riepilogo-suggerimenti-stampa {
                display: block !important; 
                page-break-before: always; 
                border: 1px solid #ccc;
                box-shadow: none;
            }

            .playground-output-box h3, 
            #riepilogo-suggerimenti-stampa h3 {
                color: #000;
                border-bottom: 2px solid #666;
            }
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Generatore Prompt Carosello</h1>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" onclick="openTab(event, 'tab-generator')">1. Generatore Prompt</button>
            <button class="tab-button" onclick="openTab(event, 'tab-playground')">2. Playground Anteprima</button>
        </nav>

        <div id="tab-generator" class="tab-content active">
             <div class="section">
                <h2 class="section-title">Dati per l'AI</h2>
                <p>Inserisci le informazioni base per generare lo storyboard del carosello.</p>

                <div class="form-group">
                    <label for="argomento">1. Argomento del post</label>
                    <input type="text" id="argomento" placeholder="Es. Il nuovo servizio di tracciamento pacchi">
                </div>

                <div class="form-group">
                    <label for="contenuto">2. Contenuto principale</label>
                    <textarea id="contenuto" placeholder="Incolla qui il testo sorgente, comunicati stampa, appunti, ecc..."></textarea>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Fonti e Opzioni</h2>
                
                <div class="form-group">
                    <label>3. Link a fonti esterne (opzionale)</label>
                    <div id="links-container">
                        </div>
                    <button class="btn btn-secondary" onclick="addLink()" style="margin-top: 0.5rem; background: #eee; color: #333; border: 2px solid #ddd;">+ Aggiungi Link</button>
                </div>

                <div class="form-group">
                    <label>4. Materiali aggiuntivi</label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="allegati">
                        <label for="allegati">Segnala all'AI che invierai materiali allegati (es. immagini, PDF) insieme al prompt.</label>
                    </label>
                </div>

                <div class="form-group">
                    <label for="note-aggiuntive">5. Informazioni aggiuntive (opzionale)</label>
                    <textarea id="note-aggiuntive" placeholder="Es. Enfatizzare l'aspetto della sostenibilità, target audience: giovani professionisti..." rows="3"></textarea>
                </div>
            </div>

            <div class="section">
                <button class="btn btn-primary" id="btn-genera" onclick="generatePrompt(this)">Genera Prompt</button>
                <button class="btn" id="btn-reset-generator" onclick="resetGenerator(this)" style="margin-left: 0.5rem; background: #e0e0e0; color: #333; border: 2px solid #ccc;">Reset Campi</button>
                
                <div id="prompt-output-container" style="display: none;">
                    <h2 class="section-title" style="margin-top: 2.5rem;">Prompt Generato</h2>
                    <p>Copia questo prompt e incollalo nel tuo strumento AI (es. Gemini).</p>
                    <textarea id="prompt-output" readonly></textarea>
                    <button class="btn btn-secondary" id="btn-copia" onclick="copyPrompt(this)" style="margin-top: 1rem;">Copia Prompt</button>
                </div>
            </div>
        </div>

        <div id="tab-playground" class="tab-content">
            
            <div class="playground-grid">

                <div class="playground-col-preview" id="playground-export-area">
                    <h2 class="section-title">Anteprima Carosello</h2>
                    
                    <div class="preview-area-wrapper">
                        
                        <div class="carousel-preview-container">
                            <div class="carousel-scroller" id="carousel-scroller">
                                <div class="carousel-slide" style="background-color: #eee; align-items: center; text-align: center; color: #888;">
                                    <p>Incolla il JSON e clicca "Visualizza Anteprima" per generare le slide.</p>
                                </div>
                            </div>
                        </div>

                        <div class="carousel-nav">
                            <button class="carousel-nav-btn" id="carousel-prev" onclick="scrollCarousel(-1)" disabled>&larr;</button>
                            <span id="carousel-pager">Slide 0 / 0</span>
                            <button class="carousel-nav-btn" id="carousel-next" onclick="scrollCarousel(1)" disabled>&rarr;</button>
                        </div>

                    </div>
                </div>

                <div class="playground-col-controls">
                    <h2 class="section-title">Controlli Playground</h2>

                    <details class="control-group" open>
                        <summary class="subsection-title">Carica Dati Storyboard (JSON)</summary>
                        <div class="form-group">
                            <label for="json-input">Incolla o importa il JSON generato</label>
                            <textarea id="json-input" rows="8" placeholder="Incolla qui il blocco JSON..."></textarea>
                            <small id="json-error">Errore: Il JSON non è valido o ha una struttura errata.</small>
                        </div>
                        
                        <input type="file" id="json-importer" accept=".json,application/json" style="display: none;" onchange="importJSON(event)">

                        <div class="button-grid" style="grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                            <button class="btn btn-primary" id="btn-preview" onclick="renderPreview(this)">Visualizza Anteprima</button>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                 <button class="btn btn-neutral" id="btn-import-json" onclick="triggerImportJSON(this)">Importa JSON</button>
                                 <button class="btn btn-neutral" id="btn-clear-json" onclick="clearJsonInput(this)">Svuota JSON</button>
                            </div>
                        </div>
                    </details>

                    <details class="control-group">
                        <summary class="subsection-title">Stile Globale (Tutte le Slide)</summary>
                        <div class="global-style-grid">
                            <label for="global-size-input">Dimensione</label>
                            <input type="range" id="global-size-input" value="1" min="0.5" max="2" step="0.05" oninput="updateGlobalStyleValue('global-size-value', this.value, 'x')">
                            <span id="global-size-value">1.00x</span>
                            
                            <label for="global-line-height-input">Interlinea</label>
                            <input type="range" id="global-line-height-input" value="1.6" min="1" max="3" step="0.1" oninput="updateGlobalStyleValue('global-line-height-value', this.value, '')">
                            <span id="global-line-height-value">1.6</span>
                            
                            <label for="global-letter-spacing-input">Spaziatura</label>
                            <input type="range" id="global-letter-spacing-input" value="0" min="-1" max="5" step="0.1" oninput="updateGlobalStyleValue('global-letter-spacing-value', this.value, 'px')">
                            <span id="global-letter-spacing-value">0.0px</span>
                        </div>
                        <button class="btn btn-secondary" id="btn-apply-global-styles" onclick="applyGlobalStyles(this)" style="width: 100%; margin-top: 0.5rem;">
                            Applica Stili Globali
                        </button>
                    </details>

                    <details class="control-group" open>
                        <summary class="subsection-title" id="local-slide-title">Modifica Slide Corrente</summary>
                        
                        <h4 class="subsection-title" style="font-size: 1rem; margin-top: 0; color: #333;">Allineamento Testo</h4>
                        <div class="layout-controls">
                            <button class="layout-btn" data-layout="top-left" title="Alto Sinistra">TL</button>
                            <button class="layout-btn" data-layout="top-center" title="Alto Centro">TC</button>
                            <button class="layout-btn" data-layout="top-right" title="Alto Destra">TR</button>
                            
                            <button class="layout-btn" data-layout="mid-left" title="Centro Sinistra">CL</button>
                            <button class="layout-btn active" data-layout="mid-center" title="Centro Centro">CC</button>
                            <button class="layout-btn" data-layout="mid-right" title="Centro Destra">CR</button>
                            
                            <button class="layout-btn" data-layout="bottom-left" title="Basso Sinistra">BL</button>
                            <button class="layout-btn" data-layout="bottom-center" title="Basso Centro">BC</button>
                            <button class="layout-btn" data-layout="bottom-right" title="Basso Destra">BR</button>
                        </div>
                        
                        <h4 class="subsection-title" style="font-size: 1rem; margin-top: 1.5rem; color: #333;">Stile Locale Testo</h4>
                        
                        <div class="color-grid">
                            <label for="color-bg-select">Sfondo</label>
                            <select id="color-bg-select">
                                <option value="#ffffff">Bianco</option>
                                <option value="#222222">Grigio Scuro</option>
                            </select>
                            
                            <label for="color-accent-select">Titoli & Strong</label>
                            <select id="color-accent-select">
                                <option value="#0146bc">Blu</option>
                                <option value="#eddc01">Giallo</option>
                                <option value="#333333">Grigio Scuro</option>
                                <option value="#ffffff">Bianco</option>
                            </select>
                        
                            <label for="color-text-select">Testo Corpo</label>
                            <select id="color-text-select">
                                <option value="#333333">Grigio Scuro</option>
                                <option value="#ffffff">Bianco</option>
                            </select>
                        
                            <label for="color-border-select">Bordo Quote</label>
                            <select id="color-border-select">
                                <option value="#eddc01">Giallo</option>
                                <option value="#0146bc">Blu</option>
                            </select>
                        </div>
                        <div class="style-grid">
                            <label for="h1-size-input">Dimensione Titolo (h1)</label>
                            <input type="number" id="h1-size-input" value="2" min="0.5" max="5" step="0.1" title="Dimensione in rem">
                            
                            <label for="p-size-input">Dimensione Corpo (p)</label>
                            <input type="number" id="p-size-input" value="1.1" min="0.5" max="3" step="0.1" title="Dimensione in rem">
                            
                            <label for="small-size-input">Dimensione Small (small)</label>
                            <input type="number" id="small-size-input" value="0.85" min="0.5" max="2" step="0.1" title="Dimensione in rem">
                        </div>
                        <button class="btn btn-neutral" id="btn-apply-styles" onclick="applyLocalStyles(this)" style="width: 100%; margin-top: 0.5rem;">
                            Applica Stili Locali
                        </button>

                        <h4 class="subsection-title" style="font-size: 1rem; margin-top: 1.5rem; color: #333;">Sfondo e Azioni Slide</h4>
                        <input type="file" id="image-uploader" accept="image/*" style="display: none;" onchange="applyBackgroundImage(event)">
                        <div class="button-grid" style="grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1rem;">
                            <button class="btn btn-neutral" id="btn-upload-bg" onclick="triggerImageUpload(this)">
                                Carica Sfondo
                            </button>
                            <button class="btn btn-secondary" id="btn-add-slide" onclick="addNewSlide(this)">+ Aggiungi Slide</button>
                            <button class="btn btn-danger" id="btn-delete-slide" onclick="deleteCurrentSlide(this)" style="grid-column: 1 / -1; min-width: 0; background-color: #fbeaea; color: var(--colore-errore); border: 2px solid #f8d7da;">
                                Elimina Slide Corrente
                            </button>
                        </div>
                    </details>

                    <details class="control-group" open>
                        <summary class="subsection-title">Output e Testi</summary>
                         <div class="playground-output-box">
                            <h3>Suggerimenti Visual (Modificabile)</h3>
                            <div class="playground-output-content" id="suggerimenti-output" contenteditable="true">
                                <p style="color: #888;">I suggerimenti per l'immagine della slide corrente appariranno qui...</p>
                            </div>
                        </div>
                         <div class="playground-output-box" style="margin-top: 1.5rem;">
                             <h3>Copy del Post (Modificabile)</h3>
                            <div class="playground-output-content" id="copy-post-output" contenteditable="true">
                                <p style="color: #888;">Il copy del post generato dall'AI apparirà qui...</p>
                            </div>
                         </div>
                        <h4 class="subsection-title" style="font-size: 1rem; margin-top: 1.5rem; color: #333;">Esporta</h4>
                         <div class="button-grid" style="grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <button class="btn btn-neutral" id="btn-export-json" onclick="exportJSON(this)">Esporta JSON</button>
                            <button class="btn btn-neutral" id="btn-export-pdf" onclick="exportToPDF(this)">Esporta PDF</button>
                            <button class="btn btn-neutral" id="btn-copy-all-text" onclick="copyAllSlideText(this)" style="grid-column: 1 / -1;">
                                Copia Testi Slide
                            </button>
                         </div>
                    </details>
                    
                    <div class="playground-output-box" id="riepilogo-suggerimenti-stampa" style="display: none;">
                        <h3>Riepilogo Suggerimenti Visual</h3>
                        <div class="playground-output-content" id="riepilogo-suggerimenti-output">
                            </div>
                    </div>
                </div>
                </div>
        </div>

    </div>

    <div id="custom-alert-overlay" class="alert-modal-overlay">
        <div class="alert-modal-box">
            <p id="custom-alert-message">Messaggio di errore.</p>
            <button class="btn btn-primary" onclick="hideCustomAlert()">OK</button>
        </div>
    </div>
    
    <script>
        let currentSlideIndex = 0;
        let totalSlides = 0;
        const scroller = document.getElementById('carousel-scroller');
        let suggerimentiOutput = document.getElementById('suggerimenti-output');
        
        let slideSuggerimenti = [];
        let slideBackgrounds = []; 
        let slideTextStyles = []; // Conterrà oggetti per { h1, p, small, colors, layout... }
        
        // Stato globale per stili globali (senza tema)
        let globalTextStyles = {
            multiplier: 1,
            lineHeight: 1.6,
            letterSpacing: '0px',
        };
        
        // Colori di default per le nuove slide
        const defaultColors = {
            bg: '#ffffff',
            accent: '#0146bc',
            text: '#333333',
            border: '#eddc01'
        };

        const pager = document.getElementById('carousel-pager');
        const btnPrev = document.getElementById('carousel-prev');
        const btnNext = document.getElementById('carousel-next');

        // Mappa layout globale (per evitare duplicazioni)
        const layoutMap = {
            'top-left':    { justifyContent: 'flex-start',  alignItems: 'flex-start' },
            'top-center':  { justifyContent: 'flex-start',  alignItems: 'center' },
            'top-right':   { justifyContent: 'flex-start',  alignItems: 'flex-end' },
            'mid-left':    { justifyContent: 'center',      alignItems: 'flex-start' },
            'mid-center':  { justifyContent: 'center',      alignItems: 'center' },
            'mid-right':   { justifyContent: 'center',      alignItems: 'flex-end' },
            'bottom-left': { justifyContent: 'flex-end',    alignItems: 'flex-start' },
            'bottom-center':{ justifyContent: 'flex-end',    alignItems: 'center' },
            'bottom-right':{ justifyContent: 'flex-end',    alignItems: 'flex-end' }
        };
        
        // --- GESTIONE CUSTOM ALERT ---
        function showCustomAlert(message) {
            document.getElementById('custom-alert-message').textContent = message;
            document.getElementById('custom-alert-overlay').classList.add('visible');
        }
        function hideCustomAlert() {
            document.getElementById('custom-alert-overlay').classList.remove('visible');
        }
        document.getElementById('custom-alert-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                hideCustomAlert();
            }
        });
        
        // Listener per salvare le modifiche ai suggerimenti
        suggerimentiOutput.addEventListener('blur', saveSuggerimento);
        
        // Listener per bottoni layout
        document.querySelector('.layout-controls').addEventListener('click', function(e) {
            if (e.target.classList.contains('layout-btn')) {
                applyLayout(e.target.dataset.layout);
            }
        });


        // --- GESTIONE TAB ---
        function openTab(event, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            event.currentTarget.classList.add("active");
        }

        // --- GESTIONE GENERATORE ---
        function addLink() {
            const container = document.getElementById('links-container');
            const linkItem = document.createElement('div');
            linkItem.className = 'link-item';
            linkItem.innerHTML = `
                <input type="text" class="link-input" placeholder="https://...">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(linkItem);
        }

        function showButtonFeedback(button, message, duration = 2000) {
            const originalText = button.innerHTML;
            button.innerHTML = message;
            button.disabled = true;
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, duration);
        }

        function generatePrompt(button) {
            showButtonFeedback(button, 'Generazione...');
            const argomento = document.getElementById('argomento').value;
            const contenuto = document.getElementById('contenuto').value;
            const allegati = document.getElementById('allegati').checked;
            const noteAggiuntive = document.getElementById('note-aggiuntive').value;
            const linkInputs = document.querySelectorAll('.link-input');
            const links = Array.from(linkInputs).map(input => input.value).filter(val => val.trim() !== '');

            // MODIFICA: Prompt aggiornato per includere la struttura blockquote
            const prompt = `
Sei un esperto social media manager e copywriter specializzato in contenuti informativi per brand istituzionali.
IL TUO COMPITO:
Crea uno storyboard dettagliato per un post carousel di Instagram (da un minimo di 3 a un massimo di 10 slide) basandoti sui seguenti dati.
DATI DI INPUT:
- Argomento: ${argomento || 'Non specificato'}
- Contenuto Principale: """
${contenuto || 'Non specificato'}
"""
${links.length > 0 ? `- Link di riferimento: \n${links.map(l => `  - ${l}`).join('\n')}` : ''}
- Presenza Materiali Allegati: ${allegati ? 'Sì' : 'No'}
- Note Aggiuntive: ${noteAggiuntive || 'Nessuna'}
REGOLE DI STILE E CONTENUTO:
1.  Tono di voce: Istituzionale, chiaro, informativo, fresco e giornalistico.
2.  Non usare la seconda persona (tu/voi). Mantenere un tono oggettivo.
3.  L'azienda autrice del post deve essere indicata in terza persona (es. "L'Azienda offre...", "Il servizio permette...").
REQUISITI DELLO STORYBOARD:
Devi produrre TRE elementi:
1.  numero_slide_consigliato: Un numero (tra 3 e 10) che ritieni ottimale.
2.  copy_post: Un testo per la caption di Instagram, scritto secondo le regole di stile.
3.  global_text_styles: Includi questo campo con valore '{}' (un oggetto vuoto).
4.  slides: Un array di oggetti, uno per ogni slide.
STRUTTURA OGGETTO SLIDE:
Ogni oggetto nell'array "slides" DEVE contenere:
-   "testo_formattato": Una stringa HTML con i testi della slide. Usa questa gerarchia:
    -   '<h1>' per il titolo della slide.
    -   '<p>' per il testo principale.
    -   '<strong>' per evidenziare termini chiave.
    -   '<blockquote>' per citazioni. La citazione DEVE essere strutturata così: <blockquote><p>Testo della citazione...</p><footer><span class="nome">Nome Cognome</span><span class="ruolo">Ruolo/Azienda</span></footer></blockquote>
    -   '<small>' per note a piè di pagina o testi secondari.
-   "suggerimento_visual": Una breve descrizione testuale dell'immagine di sfondo.
-   "background_image": Includi questo campo con valore 'null'.
-   "text_styles": Includi questo campo con valore '{}'.
FORMATO DI OUTPUT OBBLIGATORIO:
Restituisci ESCLUSIVAMENTE un singolo blocco di codice JSON valido. Non aggiungere spiegazioni prima o dopo il JSON.
Esempio di struttura JSON:
{
  "numero_slide_consigliato": 5,
  "copy_post": "Il nuovo servizio X è ora disponibile...",
  "global_text_styles": {},
  "slides": [
    {
      "testo_formattato": "<h1>Titolo Slide 1</h1><p>Testo di introduzione...</p>",
      "suggerimento_visual": "Immagine astratta blu e gialla.",
      "background_image": null,
      "text_styles": {}
    },
    {
      "testo_formattato": "<blockquote><p>Questa è una citazione importante.</p><footer><span class="nome">Mario Rossi</span><span class="ruolo">CEO</span></footer></blockquote>",
      "suggerimento_visual": "Icona stilizzata che rappresenta il servizio.",
      "background_image": null,
      "text_styles": {}
    }
  ]
}
`;
            const outputContainer = document.getElementById('prompt-output-container');
            const outputTextarea = document.getElementById('prompt-output');
            outputTextarea.value = prompt.trim();
            outputContainer.style.display = 'block';
        }

        function copyPrompt(button) {
            const outputTextarea = document.getElementById('prompt-output');
            outputTextarea.select();
            outputTextarea.setSelectionRange(0, 99999);
            try {
                var successful = document.execCommand('copy');
                showButtonFeedback(button, successful ? 'Copiato!' : 'Copia fallita');
            } catch (err) {
                showButtonFeedback(button, 'Errore copia');
            }
        }

        function resetGenerator(button) {
            document.getElementById('argomento').value = '';
            document.getElementById('contenuto').value = '';
            document.getElementById('links-container').innerHTML = '';
            document.getElementById('allegati').checked = false;
            document.getElementById('note-aggiuntive').value = '';
            document.getElementById('prompt-output-container').style.display = 'none';
            document.getElementById('prompt-output').value = '';
            showButtonFeedback(button, 'Campi resettati!');
        }

        function clearJsonInput(button) {
            document.getElementById('json-input').value = '';
            showButtonFeedback(button, 'Svuotato!');
        }

        // --- GESTIONE PLAYGROUND ---

        // MODIFICA: Funzione helper per applicare colori granulari
        function applySlideColors(slideElement, textBlockElement, colors) {
            const c = { ...defaultColors, ...colors }; // Unisci con i default
            
            slideElement.style.backgroundColor = c.bg;
            textBlockElement.style.setProperty('--colore-testo-h1', c.accent);
            textBlockElement.style.setProperty('--colore-testo-strong', c.accent);
            textBlockElement.style.setProperty('--colore-testo-p', c.text);
            textBlockElement.style.setProperty('--colore-testo-small', c.text);
            textBlockElement.style.setProperty('--colore-blockquote-text', c.text);
            textBlockElement.style.setProperty('--colore-blockquote-border', c.border);
        }

        // MODIFICA: Aggiornata per leggere 'styles.colors'
        function createSlideElement(slideData) {
            const slide = document.createElement('div');
            slide.className = 'carousel-slide';
            
            const textContent = document.createElement('div');
            textContent.className = 'text-overlay-block';
            textContent.setAttribute('contenteditable', 'true');
            
            let cleanHtml = slideData.testo_formattato || '<p>(Testo mancante)</p>';
            textContent.innerHTML = cleanHtml.replace(/\u00A0/g, " ");

            // Applica stili granulari
            if (slideData.text_styles) {
                const styles = slideData.text_styles;
                
                if (styles.h1 && styles.h1.fontSize) {
                    textContent.style.setProperty('--local-h1-size', styles.h1.fontSize);
                }
                if (styles.p && styles.p.fontSize) {
                    textContent.style.setProperty('--local-p-size', styles.p.fontSize);
                }
                if (styles.small && styles.small.fontSize) {
                    textContent.style.setProperty('--local-small-size', styles.small.fontSize);
                }
                
                // Applica layout
                const layout = styles.layout || 'mid-center';
                const flexStyles = layoutMap[layout] || layoutMap['mid-center'];
                slide.style.justifyContent = flexStyles.justifyContent;
                slide.style.alignItems = flexStyles.alignItems;

                // Applica colori granulari
                applySlideColors(slide, textContent, styles.colors || defaultColors);
                
            } else {
                 // Default layout e colori
                slide.style.justifyContent = 'center';
                slide.style.alignItems = 'center';
                applySlideColors(slide, textContent, defaultColors);
            }

            slide.appendChild(textContent);

            if (slideData.background_image) {
                slide.style.backgroundImage = `url(${slideData.background_image})`;
            }
            return slide;
        }

        // MODIFICA: Rimuove logica 'theme' e 'themeNegativo'
        function renderPreview(button) {
            showButtonFeedback(button, 'Caricamento...');
            let jsonInput = document.getElementById('json-input').value;
            const errorMsg = document.getElementById('json-error');
            const copyOutput = document.getElementById('copy-post-output');

            scroller.innerHTML = ''; 
            slideSuggerimenti = []; 
            slideBackgrounds = [];
            slideTextStyles = []; // Resetta gli stili

            // Resetta stato globale a default
            globalTextStyles = { multiplier: 1, lineHeight: 1.6, letterSpacing: '0px' };

            errorMsg.style.display = 'none';

            try {
                const cleanJsonInput = jsonInput.replace(/\u00A0/g, " ");
                const data = JSON.parse(cleanJsonInput);

                if (!data.slides || !Array.isArray(data.slides) || !data.copy_post) {
                    throw new Error('Struttura JSON non valida.');
                }
                
                // Carica stili globali se esistono
                if (data.global_text_styles && typeof data.global_text_styles === 'object') {
                    globalTextStyles.multiplier = data.global_text_styles.multiplier || 1;
                    globalTextStyles.lineHeight = data.global_text_styles.lineHeight || 1.6;
                    globalTextStyles.letterSpacing = data.global_text_styles.letterSpacing || '0px';
                }
                // Applica stili globali caricati
                applyGlobalStylesToDOM();
                updateGlobalStyleInputs();
                
                copyOutput.innerHTML = `<p>${data.copy_post.replace(/\n/g, '<br>')}</p>`;
                totalSlides = data.slides.length;
                if (totalSlides === 0) {
                     throw new Error('Nessuna slide trovata nel JSON.');
                }

                data.slides.forEach((slideData, index) => {
                    let styles = slideData.text_styles || {};

                    // TRANCODIFICA per compatibilità vecchi JSON
                    if (styles.theme === 'grigio-blu' || styles.themeNegativo === true) {
                        styles.colors = {
                            bg: '#222222',
                            accent: '#0146bc',
                            text: '#ffffff',
                            border: '#0146bc'
                        };
                    } else if (styles.theme === 'bianco-giallo') {
                         styles.colors = {
                            bg: '#ffffff',
                            accent: '#eddc01',
                            text: '#333333',
                            border: '#eddc01'
                        };
                    }
                    delete styles.theme;
                    delete styles.themeNegativo;
                    
                    // Salva i dati negli array di stato
                    slideTextStyles[index] = styles;
                    slideBackgrounds[index] = slideData.background_image || null;
                    slideSuggerimenti.push(slideData.suggerimento_visual || '(Nessun suggerimento)');
                    
                    // Crea e aggiungi l'elemento slide (passando gli stili aggiornati)
                    const slideElement = createSlideElement({ ...slideData, text_styles: styles });
                    scroller.appendChild(slideElement);
                });

                currentSlideIndex = 0;
                updateCarouselState();
                updateRiepilogoStampa();

            } catch (e) {
                console.error("Errore parsing JSON:", e);
                errorMsg.style.display = 'block';
                copyOutput.innerHTML = '<p style="color: #888;">...</p>';
                scroller.innerHTML = `<div class="carousel-slide" style="background-color: #eee; align-items: center; text-align: center; color: var(--colore-errore);"><p><strong>Errore.</strong><br>Controlla il JSON e riprova.</p></div>`;
                totalSlides = 0;
                currentSlideIndex = 0;
                updateCarouselState();
            }
        }

        function saveSuggerimento() {
            if (totalSlides > 0 && currentSlideIndex < slideSuggerimenti.length) {
                slideSuggerimenti[currentSlideIndex] = suggerimentiOutput.innerHTML;
                updateRiepilogoStampa();
            }
        }

        function updateRiepilogoStampa() {
            const riepilogoContainer = document.getElementById('riepilogo-suggerimenti-output');
            if (totalSlides === 0) {
                riepilogoContainer.innerHTML = '';
                return;
            }
            let html = '<ul>';
            slideSuggerimenti.forEach((sugg, index) => {
                const cleanSugg = sugg.replace(/^<p>/i, '').replace(/<\/p>$/i, '');
                html += `<li style="margin-bottom: 0.75rem;"><strong>Slide ${index + 1}:</strong> ${cleanSugg}</li>`;
            });
            html += '</ul>';
            riepilogoContainer.innerHTML = html;
        }

        // MODIFICA: Aggiornato per leggere/scrivere sui <select> del colore
        function updateCarouselState() {
            pager.textContent = `Slide ${currentSlideIndex + 1} / ${totalSlides}`;
            btnPrev.disabled = (currentSlideIndex === 0);
            btnNext.disabled = (currentSlideIndex === totalSlides - 1 || totalSlides === 0);
            
            // Aggiorna titolo accordion
            document.getElementById('local-slide-title').textContent = `Modifica Slide Corrente (${currentSlideIndex + 1}/${totalSlides})`;

            if (totalSlides > 0) {
                suggerimentiOutput.innerHTML = slideSuggerimenti[currentSlideIndex];

                // AGGIORNA CONTROLLI DI STILE LOCALI (Dimensione e Tema)
                const currentStyles = slideTextStyles[currentSlideIndex] || {};
                
                const defaults = {
                    h1: { fontSize: '2rem' },
                    p: { fontSize: '1.1rem' },
                    small: { fontSize: '0.85rem' },
                    colors: defaultColors,
                    layout: 'mid-center'
                };

                const h1Styles = currentStyles.h1 || defaults.h1;
                const pStyles = currentStyles.p || defaults.p;
                const smallStyles = currentStyles.small || defaults.small;
                const colors = { ...defaults.colors, ...(currentStyles.colors || {}) };

                // Popola Dimensioni
                document.getElementById('h1-size-input').value = parseFloat(h1Styles.fontSize) || parseFloat(defaults.h1.fontSize);
                document.getElementById('p-size-input').value = parseFloat(pStyles.fontSize) || parseFloat(defaults.p.fontSize);
                document.getElementById('small-size-input').value = parseFloat(smallStyles.fontSize) || parseFloat(defaults.small.fontSize);
                
                // Popola Colori Locali
                document.getElementById('color-bg-select').value = colors.bg;
                document.getElementById('color-accent-select').value = colors.accent;
                document.getElementById('color-text-select').value = colors.text;
                document.getElementById('color-border-select').value = colors.border;
                
                // Aggiorna stato bottoni layout
                const currentLayout = currentStyles.layout || defaults.layout;
                document.querySelectorAll('.layout-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.layout === currentLayout);
                });


            } else {
                 suggerimentiOutput.innerHTML = '<p style="color: #888;">...</p>';
                 // Disattiva tutti i bottoni layout
                 document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));
                 // Resetta select colori
                 document.getElementById('color-bg-select').value = defaultColors.bg;
                 document.getElementById('color-accent-select').value = defaultColors.accent;
                 document.getElementById('color-text-select').value = defaultColors.text;
                 document.getElementById('color-border-select').value = defaultColors.border;
            }
        }

        // --- NUOVE FUNZIONI STILE ---

        function updateGlobalStyleValue(elementId, value, suffix) {
            let displayValue = parseFloat(value).toFixed(suffix === 'x' ? 2 : 1);
            document.getElementById(elementId).textContent = displayValue + suffix;
        }

        function updateGlobalStyleInputs() {
            document.getElementById('global-size-input').value = globalTextStyles.multiplier;
            document.getElementById('global-line-height-input').value = globalTextStyles.lineHeight;
            document.getElementById('global-letter-spacing-input').value = parseFloat(globalTextStyles.letterSpacing);
            
            updateGlobalStyleValue('global-size-value', globalTextStyles.multiplier, 'x');
            updateGlobalStyleValue('global-line-height-value', globalTextStyles.lineHeight, '');
            updateGlobalStyleValue('global-letter-spacing-value', globalTextStyles.letterSpacing, 'px');
        }

        function applyGlobalStylesToDOM() {
            scroller.style.setProperty('--global-font-size-multiplier', globalTextStyles.multiplier);
            scroller.style.setProperty('--global-line-height', globalTextStyles.lineHeight);
            scroller.style.setProperty('--global-letter-spacing', globalTextStyles.letterSpacing);
        }

        function applyGlobalStyles(button) {
            globalTextStyles.multiplier = document.getElementById('global-size-input').value;
            globalTextStyles.lineHeight = document.getElementById('global-line-height-input').value;
            globalTextStyles.letterSpacing = document.getElementById('global-letter-spacing-input').value + 'px';
            applyGlobalStylesToDOM();
            showButtonFeedback(button, 'Stili Globali Applicati!');
        }


        // MODIFICA: Aggiornato per leggere/scrivere sui <select> del colore
        function applyLocalStyles(button) {
            if (totalSlides === 0) {
                showButtonFeedback(button, 'Nessuna slide');
                return;
            }

            const allSlides = scroller.querySelectorAll('.carousel-slide'); // Ora prende .carousel-slide
            const currentSlideElement = allSlides[currentSlideIndex];
            if (!currentSlideElement) return;
            const currentTextBlock = currentSlideElement.querySelector('.text-overlay-block');

            // 1. Leggi i valori dagli input
            const h1Size = document.getElementById('h1-size-input').value + 'rem';
            const pSize = document.getElementById('p-size-input').value + 'rem';
            const smallSize = document.getElementById('small-size-input').value + 'rem';
            
            const colors = {
                bg: document.getElementById('color-bg-select').value,
                accent: document.getElementById('color-accent-select').value,
                text: document.getElementById('color-text-select').value,
                border: document.getElementById('color-border-select').value
            };

            // 2. Costruisci l'oggetto stili (dimensioni + colori)
            const newStyles = {
                h1: { fontSize: h1Size },
                p: { fontSize: pSize },
                small: { fontSize: smallSize },
                colors: colors
            };

            // 3. Applica gli stili come variabili CSS locali al blocco testo
            currentTextBlock.style.setProperty('--local-h1-size', h1Size);
            currentTextBlock.style.setProperty('--local-p-size', pSize);
            currentTextBlock.style.setProperty('--local-small-size', smallSize);
            
            // Applica colori
            applySlideColors(currentSlideElement, currentTextBlock, colors);

            // 4. Salva nello stato globale, preservando il layout
            if (!slideTextStyles[currentSlideIndex]) {
                slideTextStyles[currentSlideIndex] = {};
            }
            // Unisci i nuovi stili di testo (h1, p, small, colors) con il layout esistente
            Object.assign(slideTextStyles[currentSlideIndex], newStyles);

            showButtonFeedback(button, 'Stili Locali Applicati!');
        }

        // NUOVA: Funzione per applicare layout
        function applyLayout(layout) {
            if (totalSlides === 0) return;
            
            const allSlides = scroller.querySelectorAll('.carousel-slide');
            const currentSlideElement = allSlides[currentSlideIndex];
            if (!currentSlideElement) return;

            const styles = layoutMap[layout] || layoutMap['mid-center']; // Default
            
            // Applica gli stili al .carousel-slide (il contenitore flex)
            currentSlideElement.style.justifyContent = styles.justifyContent;
            currentSlideElement.style.alignItems = styles.alignItems;
            
            // Salva lo stato
            if (!slideTextStyles[currentSlideIndex]) {
                slideTextStyles[currentSlideIndex] = {};
            }
            slideTextStyles[currentSlideIndex].layout = layout;
            
            // Aggiorna UI dei bottoni
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.layout === layout);
            });
        }


        function scrollCarousel(direction) {
            saveSuggerimento();
            const newIndex = currentSlideIndex + direction;
            if (newIndex < 0 || newIndex >= totalSlides) {
                return;
            }
            const scrollAmount = scroller.clientWidth * newIndex;
            scroller.scrollTo({
                left: scrollAmount,
                behavior: 'smooth'
            });
            currentSlideIndex = newIndex;
            updateCarouselState();
        }

        scroller.addEventListener('scroll', () => {
            const index = Math.round(scroller.scrollLeft / scroller.clientWidth);
            if (index !== currentSlideIndex && index < totalSlides) {
                saveSuggerimento();
                currentSlideIndex = index;
                updateCarouselState();
            }
        });

        function exportToPDF(button) {
            saveSuggerimento();
            showButtonFeedback(button, 'Prepara stampa...');
            
            const oldGlobalLetterSpacing = scroller.style.getPropertyValue('--global-letter-spacing');
            scroller.querySelectorAll('.text-overlay-block').forEach(el => {
                el.style.letterSpacing = 'normal';
                el.style.wordSpacing = 'normal';
            });
            scroller.style.setProperty('--global-letter-spacing', 'normal');
            
            window.print();
            
            scroller.style.setProperty('--global-letter-spacing', oldGlobalLetterSpacing);
            scroller.querySelectorAll('.text-overlay-block').forEach(el => {
                el.style.letterSpacing = ''; 
                el.style.wordSpacing = ''; 
            });
        }

        function copyAllSlideText(button) {
            const slides = document.querySelectorAll('#carousel-scroller .text-overlay-block');
            if (slides.length === 0 || totalSlides === 0) {
                showButtonFeedback(button, 'Niente da copiare');
                return;
            }
            let allText = '';
            slides.forEach((slide, index) => {
                const text = slide.textContent || slide.innerText; 
                allText += `--- SLIDE ${index + 1} ---\n`;
                allText += text.trim();
                allText += '\n\n';
            });

            const tempTextarea = document.createElement('textarea');
            tempTextarea.style.position = 'absolute';
            tempTextarea.style.left = '-9999px';
            tempTextarea.value = allText.trim();
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            tempTextarea.setSelectionRange(0, 99999);
            try {
                var successful = document.execCommand('copy');
                showButtonFeedback(button, successful ? 'Testi copiati!' : 'Copia fallita');
            } catch (err) {
                showButtonFeedback(button, 'Errore copia');
            }
            document.body.removeChild(tempTextarea);
        }

        // --- Funzioni Import/Export JSON ---
        function exportJSON(button) {
            if (totalSlides === 0) {
                showButtonFeedback(button, 'Nessun dato');
                return;
            }
            showButtonFeedback(button, 'Esportazione...');
            saveSuggerimento();

            const copyText = document.getElementById('copy-post-output').textContent || '';
            const slideElements = document.querySelectorAll('#carousel-scroller .text-overlay-block');
            const slidesData = [];

            slideElements.forEach((el, index) => {
                const cleanHtml = el.innerHTML.replace(/\u00A0/g, " ");

                slidesData.push({
                    testo_formattato: cleanHtml, 
                    suggerimento_visual: slideSuggerimenti[index] || '(Nessun suggerimento)',
                    background_image: slideBackgrounds[index] || null,
                    text_styles: slideTextStyles[index] || {} // Salva stili locali (dimensioni + layout + colors)
                });
            });

            const exportObj = {
                numero_slide_consigliato: totalSlides,
                copy_post: copyText.trim(),
                global_text_styles: globalTextStyles, // Salva solo stili globali (no tema)
                slides: slidesData
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "storyboard_modificato.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function triggerImportJSON(button) {
            showButtonFeedback(button, 'Apri finestra...');
            document.getElementById('json-importer').click();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    document.getElementById('json-input').value = text;
                    renderPreview(document.getElementById('btn-preview'));
                } catch (err) {
                    console.error("Errore lettura file:", err);
                    document.getElementById('json-error').style.display = 'block';
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        // --- Funzioni Immagini ---

        function triggerImageUpload(button) {
            if (totalSlides === 0) {
                showButtonFeedback(button, 'Crea anteprima');
                return;
            }
            document.getElementById('image-uploader').click();
        }

        function applyBackgroundImage(event) {
            const file = event.target.files[0];
            if (!file || totalSlides === 0) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataURL = e.target.result;
                const allSlides = scroller.querySelectorAll('.carousel-slide');
                const currentSlideElement = allSlides[currentSlideIndex];
                if (currentSlideElement) {
                    currentSlideElement.style.backgroundImage = `url(${dataURL})`;
                    slideBackgrounds[currentSlideIndex] = dataURL;
                }
            };
            reader.readAsDataURL(file); 
            event.target.value = null;
        }

        // --- NUOVE FUNZIONI: Aggiungi/Elimina Slide ---

        // MODIFICA: Aggiornato per impostare 'colors: defaultColors'
        function addNewSlide(button) {
            showButtonFeedback(button, 'Aggiunta...');
            
            const newIndex = currentSlideIndex + 1;
            
            const newSlideData = {
                testo_formattato: `<h1>Slide ${newIndex + 1}</h1><p>Nuovo contenuto...</p>`,
                suggerimento_visual: "(Nessun suggerimento)",
                background_image: null,
                text_styles: { 
                    layout: 'mid-center', 
                    colors: defaultColors // Usa i colori di default
                }
            };

            // 1. Inserisci i dati negli array di stato
            slideSuggerimenti.splice(newIndex, 0, newSlideData.suggerimento_visual);
            slideBackgrounds.splice(newIndex, 0, newSlideData.background_image);
            slideTextStyles.splice(newIndex, 0, newSlideData.text_styles);
            
            // 2. Crea l'elemento DOM
            const newSlideElement = createSlideElement(newSlideData);
            
            // 3. Inserisci l'elemento nel DOM
            const allSlides = scroller.querySelectorAll('.carousel-slide');
            if (newIndex >= allSlides.length) {
                scroller.appendChild(newSlideElement); // Aggiungi alla fine
            } else {
                scroller.insertBefore(newSlideElement, allSlides[newIndex]); // Inserisci in mezzo
            }
            
            // 4. Aggiorna stato e naviga
            totalSlides++;
            scrollCarousel(1); // Naviga alla nuova slide (aggiorna anche lo stato)
            updateRiepilogoStampa();
        }

        function deleteCurrentSlide(button) {
            if (totalSlides <= 1) {
                showCustomAlert("Impossibile eliminare l'unica slide rimasta.");
                return;
            }
            
            if (!confirm("Sei sicuro di voler eliminare questa slide?")) {
                return;
            }
            
            showButtonFeedback(button, 'Eliminazione...');

            const indexToDelete = currentSlideIndex;

            // 1. Rimuovi i dati dagli array di stato
            slideSuggerimenti.splice(indexToDelete, 1);
            slideBackgrounds.splice(indexToDelete, 1);
            slideTextStyles.splice(indexToDelete, 1);
            
            // 2. Rimuovi l'elemento dal DOM
            const allSlides = scroller.querySelectorAll('.carousel-slide');
            allSlides[indexToDelete].remove();
            
            // 3. Aggiorna stato
            totalSlides--;
            // Se elimini l'ultima, torna indietro
            if (indexToDelete >= totalSlides) {
                currentSlideIndex = totalSlides - 1;
            }
            
            // Forza un "ri-allineamento" dello scroller e aggiorna l'UI
            const scrollAmount = scroller.clientWidth * currentSlideIndex;
            scroller.scrollTo({ left: scrollAmount, behavior: 'auto' });
            updateCarouselState();
            updateRiepilogoStampa();
        }

    </script>
</body>
</html>
