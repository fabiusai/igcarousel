<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Prompt Carosello</title>
    <link rel="icon" href="favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">


    <style>
        /* Stile Globale e Variabili Colore */
        :root {
            --colore-primario: #0146bc; /* Blu */
            --colore-secondario: #eddc01; /* Giallo */
            --colore-testo: #333;
            --colore-testo-chiaro: #ffffff;
            --colore-sfondo: #f4f7fa;
            --colore-bordo: #d8dee4;
            --colore-neutro-chiaro: #f9f9f9;
            --colore-neutro-scuro: #555;
            --colore-errore: #d93025;

            /* --- NUOVE VARIABILI TEMA TESTO --- */
            /* Questi sono i default per il Tema Standard */
            --colore-testo-h1: var(--colore-primario);
            --colore-testo-p: var(--colore-testo);
            --colore-testo-small: var(--colore-neutro-scuro);
            --colore-testo-strong: var(--colore-primario);
            --colore-blockquote-border: var(--colore-secondario);
            --colore-blockquote-text: var(--colore-neutro-scuro);
        }

        /* --- STILI TEMA NEGATIVO (PER SLIDE) --- */
        /* Questa classe viene aggiunta a .carousel-slide */
        .carousel-slide.theme-negativo {
            /* Sfondo scuro per leggibilità */
            background-color: #222; 
            
            /* Blu -> Giallo */
            --colore-testo-h1: var(--colore-secondario);
            --colore-testo-strong: var(--colore-secondario);
            
            /* Nero/Grigio -> Bianco */
            --colore-testo-p: var(--colore-testo-chiaro);
            --colore-testo-small: var(--colore-testo-chiaro);
            --colore-blockquote-text: var(--colore-testo-chiaro);

            /* Giallo -> Blu */
            --colore-blockquote-border: var(--colore-primario);
        }


        body {
            /* MODIFICATO: Uso Inter per coerenza, se lo includi */
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            background-color: var(--colore-sfondo);
            color: var(--colore-testo);
            line-height: 1.6;
        }

        /* ...Tutto il resto del CSS fino a .text-overlay-block... */
        
        /* Contenitore Principale */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Header */
        header {
            background-color: var(--colore-primario);
            color: var(--colore-testo-chiaro);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        header h1 {
            margin: 0;
            font-size: 1.75rem;
            text-align: center;
        }

        /* Navigazione Tab */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid var(--colore-bordo);
            margin-bottom: -2px; /* Sovrapposizione per la linea attiva */
            z-index: 1;
            position: relative;
        }

        .tab-button {
            padding: 0.85rem 1.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            background-color: transparent;
            cursor: pointer;
            color: var(--colore-neutro-scuro);
            border-radius: 8px 8px 0 0;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            background-color: var(--colore-neutro-chiaro);
        }

        .tab-button.active {
            color: var(--colore-primario);
            border-bottom: 3px solid var(--colore-primario);
            background-color: var(--colore-testo-chiaro);
        }

        /* Contenuto Tab */
        .tab-content {
            display: none;
            background-color: var(--colore-testo-chiaro);
            padding: 2.5rem;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--colore-bordo);
            border-top: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Sezioni Interne */
        .section {
            margin-bottom: 2.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--colore-primario);
            border-bottom: 3px solid var(--colore-secondario);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* Elementi Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--colore-neutro-scuro);
        }

        input[type="text"],
        input[type="number"], 
        input[type="range"],
        textarea {
            width: 100%;
            padding: 0.85rem;
            font-size: 1rem;
            border: 2px solid var(--colore-bordo);
            border-radius: 8px;
            box-sizing: border-box; 
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        input[type="range"] {
            padding: 0.25rem;
        }

        input[type="text"]:focus,
        input[type="number"]:focus, 
        input[type="range"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--colore-primario);
            box-shadow: 0 0 0 3px rgba(1, 70, 188, 0.2);
        }

        textarea {
            min-height: 180px;
            resize: vertical;
        }

        /* Checkbox (usato per Tema e per Generatore) */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .checkbox-group:hover {
            background-color: var(--colore-neutro-chiaro);
        }
        
        input[type="checkbox"] {
            width: 1.25em;
            height: 1.25em;
            accent-color: var(--colore-primario);
            cursor: pointer;
        }
        .checkbox-group label {
            margin-bottom: 0; /* Override */
            cursor: pointer;
        }


        /* Bottoni */
        .btn {
            padding: 0.85rem 1.75rem;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 150px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--colore-primario);
            color: var(--colore-testo-chiaro);
        }

        .btn-primary:hover {
            background-color: #00338a; /* Blu più scuro */
        }

        .btn-secondary {
            background-color: var(--colore-secondario);
            color: var(--colore-primario);
            border: 2px solid var(--colore-secondario);
        }

        .btn-secondary:hover {
            background-color: #d4c400; /* Giallo più scuro */
            border-color: #d4c400;
        }

        /* Stile per bottoni "neutri" (grigi) */
        .btn-neutral {
            background-color: #f0f0f0; /* Grigio chiaro */
            color: #333;
            border: 2px solid #dcdcdc;
        }

        .btn-neutral:hover {
            background-color: #e0e0e0;
            border-color: #ccc;
        }

        /* Titoli per sottosezioni nel playground */
        .subsection-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--colore-neutro-scuro);
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--colore-bordo);
            padding-bottom: 0.25rem;
        }

        .btn-danger {
            background-color: var(--colore-errore);
            color: var(--colore-testo-chiaro);
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            min-width: auto;
        }

        /* Area Link Dinamici */
        .link-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .link-item input {
            flex-grow: 1;
        }

        /* Area Output Prompt */
        #prompt-output-container {
            margin-top: 1.5rem;
        }

        #prompt-output {
            min-height: 250px;
            background-color: var(--colore-neutro-chiaro);
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* --- STILI PLAYGROUND --- */

        .playground-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2.5rem;
        }

        @media (min-width: 1024px) {
            .playground-grid {
                /* (Carousel + Suggerimenti) | (JSON Input + Controlli) */
                grid-template-columns: minmax(350px, 450px) 1fr;
            }
        }
        
        .playground-col-preview {
            max-width: 450px;
            margin: 0 auto;
            width: 100%;
        }

        /* Stile Carousel Preview */
        .carousel-preview-container {
            position: relative;
            width: 100%;
            border: 1px solid var(--colore-bordo);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .carousel-scroller {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; 
            
            /* --- VARIABILI GLOBALI TESTO --- */
            /* Queste vengono modificate da JS */
            --global-font-size-multiplier: 1;
            --global-line-height: 1.6;
            --global-letter-spacing: 0px;
        }

        .carousel-slide {
            flex: 0 0 100%;
            width: 100%;
            aspect-ratio: 4 / 5;
            scroll-snap-align: start;
            padding: 1.75rem;
            box-sizing: border-box;
            background: var(--colore-testo-chiaro);
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: auto; 
            border-right: 1px solid var(--colore-bordo);
            
            position: relative; 
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }
                
        .carousel-slide:last-child {
            border-right: none;
        }

        .carousel-nav {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background-color: var(--colore-neutro-chiaro);
            border-top: 1px solid var(--colore-bordo);
        }

        .carousel-nav-btn {
            background: var(--colore-primario);
            color: var(--colore-testo-chiaro);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .carousel-nav-btn:hover {
            background-color: #00338a;
        }

        .carousel-nav-btn:disabled {
            background-color: var(--colore-bordo);
            cursor: not-allowed;
        }

        /* Stile Testi Slide (ora usa VARIABILI) */
        .text-overlay-block {
            position: relative; 
            cursor: move;
            z-index: 10;
            width: 90%; 
            max-width: 90%; 
            box-sizing: border-box;
            
            /* Stili globali applicati qui */
            line-height: var(--global-line-height);
            letter-spacing: var(--global-letter-spacing);
        }

        /* --- INIZIO CORREZIONE CSS (Interlinea tra blocchi) --- */
        .text-overlay-block h1 {
            font-size: calc(var(--local-h1-size, 2rem) * var(--global-font-size-multiplier));
            color: var(--colore-testo-h1);
            /* margin: 0 0 1rem 0; */
            margin: 0 0 calc(1rem * var(--global-line-height, 1.6)) 0;
            line-height: 1.2; 
        }
        .text-overlay-block p {
            font-size: calc(var(--local-p-size, 1.1rem) * var(--global-font-size-multiplier));
            /* margin: 0.5rem 0; */
            margin: calc(0.5rem * var(--global-line-height, 1.6)) 0;
            color: var(--colore-testo-p);
        }
        .text-overlay-block strong {
            color: var(--colore-testo-strong);
            font-weight: 700;
        }
        .text-overlay-block blockquote {
            border-left: 4px solid var(--colore-blockquote-border);
            padding-left: 1.25rem;
            /* margin: 1rem 0; */
            margin: calc(1rem * var(--global-line-height, 1.6)) 0;
            font-style: italic;
            font-size: calc(var(--local-p-size, 1.1rem) * var(--global-font-size-multiplier)); /* Usa stessa size di P */
            color: var(--colore-blockquote-text);
        }
        .text-overlay-block small {
            font-size: calc(var(--local-small-size, 0.85rem) * var(--global-font-size-multiplier));
            color: var(--colore-testo-small);
            opacity: 0.9;
            display: block;
            /* margin-top: 1rem; */
            margin-top: calc(1rem * var(--global-line-height, 1.6));
        }
        /* --- FINE CORREZIONE CSS --- */


        /* Sezioni Output Playground (Suggerimenti e Copy) */
        .playground-output-box {
            margin-top: 1.5rem;
            border: 2px solid var(--colore-bordo);
            border-radius: 8px;
        }

        .playground-output-box h3 {
            font-size: 1.1rem;
            margin: 0;
            padding: 0.75rem 1rem;
            background-color: var(--colore-neutro-chiaro);
            border-bottom: 2px solid var(--colore-bordo);
            color: var(--colore-primario);
        }

        .playground-output-content {
            padding: 1rem;
            min-height: 100px;
            background-color: var(--colore-testo-chiaro);
            border-radius: 0 0 6px 6px;
        }

        /* Area per feedback e elementi modificabili */
        #json-error {
            color: var(--colore-errore);
            font-weight: 600;
            display: none;
            margin-top: 0.5rem;
        }
        
        .text-overlay-block[contenteditable="true"] {
            outline: 2px dashed transparent;
            transition: outline 0.2s ease;
            padding: 0.5rem; 
            border-radius: 4px;
        }

        .text-overlay-block[contenteditable="true"]:hover,
        .text-overlay-block[contenteditable="true"]:focus-within {
            outline: 2px dashed var(--colore-primario);
            background-color: rgba(255, 255, 255, 0.2); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Tema negativo outline */
        .carousel-slide.theme-negativo .text-overlay-block[contenteditable="true"]:hover,
        .carousel-slide.theme-negativo .text-overlay-block[contenteditable="true"]:focus-within {
             outline: 2px dashed var(--colore-secondario);
             background-color: rgba(255, 255, 255, 0.1); 
        }


        /* Griglia Stili Granulari (Ora solo Dimensione) */
        .style-grid {
            display: grid;
            grid-template-columns: auto 1fr; /* Label, Dimensione (rem) */
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .style-grid label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--colore-neutro-scuro);
        }
        .style-grid input[type="number"] {
            padding: 0.5rem; /* Ridotto per griglia */
            font-size: 0.9rem;
            margin: 0;
        }
        
        /* Griglia Stili Globali */
        .global-style-grid {
            display: grid;
            grid-template-columns: auto 1fr auto; /* Label, Range, Valore */
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .global-style-grid label {
             font-weight: 600;
            font-size: 0.9rem;
            color: var(--colore-neutro-scuro);
            margin-bottom: 0;
        }
        .global-style-grid span {
            font-family: monospace;
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 45px;
            text-align: right;
        }

        /* --- STILI CUSTOM ALERT MODAL --- */
        .alert-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s;
        }
        .alert-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .alert-modal-box {
            background: var(--colore-testo-chiaro);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }
        .alert-modal-overlay.visible .alert-modal-box {
            transform: scale(1);
        }
        .alert-modal-box p {
            margin: 0 0 1.5rem 0;
            font-size: 1.1rem;
            color: var(--colore-testo);
        }
        /* --- Fine STILI CUSTOM ALERT MODAL --- */


        /* --- NUOVI STILI PER MODAL CATTURA --- */
        .capture-overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Sfondo grigio scuro come richiesto */
            background-color: #333333; 
            display: grid;
            place-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }
        .capture-overlay-container.visible {
            opacity: 1;
            visibility: visible;
        }
        /* Questo wrapper ferma il click-to-close */
        .capture-content-wrapper {
            cursor: default;
            /* Definiamo la dimensione della slide qui */
            height: 85vh; /* Molto grande */
            width: auto;
            max-width: 90vw;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        /* Applica lo stile alla slide clonata */
        .capture-content-wrapper .carousel-slide {
            /* Forza angoli non arrotondati */
            border-radius: 0 !important; 
            /* Forza 100% dell'altezza del wrapper */
            height: 100%;
            width: 100%;
            /* Rimuovi bordi superflui */
            border: none;
            box-shadow: none;
            /* Assicura che overflow non rovini lo screenshot */
            overflow: hidden; 
        }
        .capture-close-info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #aaa;
            font-weight: 600;
            padding: 5px 15px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 20px;
        }
        /* --- FINE STILI MODAL CATTURA --- */


        /* --- STILI DI STAMPA PER PDF --- */
        @media print {
            body * {
                visibility: hidden;
            }

            #tab-playground, #tab-playground * {
                visibility: visible;
            }

            header, .tab-nav, #tab-generator, 
            .playground-col-controls label, #json-input, 
            /* RIMOSSO SVG, RIMOSSO PNG, AGGIUNTO NUOVO BTN */
            #btn-capture-slide, #btn-export-pdf, 
            .carousel-nav, #suggerimenti-output, 
            .playground-output-box h3:first-child,
            #btn-upload-bg, #image-uploader,
            .subsection-title,
            .form-group, /* Nasconde vecchi form-group */
            .style-grid, /* Nasconde nuova griglia stili locali */
            .global-style-grid, /* Nasconde griglia stili globali */
            #btn-apply-styles, /* Nasconde nuovo bottone locali */
            #btn-apply-global-styles, /* Nasconde bottone globali */
            #local-theme-toggle-group /* Nasconde tema locale */
            {
                display: none !important;
            }

            body {
                background-color: #ffffff;
                margin: 0;
                padding: 0;
            }

            #tab-playground {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1rem;
                box-shadow: none;
                border: none;
            }

            .playground-grid {
                display: block;
            }

            .carousel-scroller {
                display: block;
                overflow: visible;
                height: auto;
            }

            .carousel-slide {
                display: block;
                width: 90%; 
                margin: 0 auto;
                height: auto;
                aspect-ratio: unset; 
                padding: 1.5rem;
                border: 2px solid var(--colore-bordo);
                box-shadow: none;
                page-break-after: always; 
                
                background-size: cover !important;
                background-position: center !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            
            .text-overlay-block {
                position: relative !important; 
                top: auto !important;
                left: auto !important;
                width: 100% !important;
            }
            /* Forza stili leggibili per la stampa (ignora tema) */
            .text-overlay-block, .text-overlay-block * {
                color: #000 !important;
                background: transparent !important;
                line-height: 1.5 !important;
                letter-spacing: normal !important;
            }
            /* Forza font-size specifici per stampa se necessario */
            .text-overlay-block h1 { font-size: 24pt !important; }
            .text-overlay-block p { font-size: 11pt !important; }
            .text-overlay-block small { font-size: 8pt !important; }


            .carousel-slide:last-child {
                page-break-after: auto;
            }

            .playground-output-box, 
            #riepilogo-suggerimenti-stampa {
                display: block !important; 
                page-break-before: always; 
                border: 1px solid #ccc;
                box-shadow: none;
            }

            .playground-output-box h3, 
            #riepilogo-suggerimenti-stampa h3 {
                color: #000;
                border-bottom: 2px solid #666;
            }
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Generatore Prompt Carosello</h1>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" onclick="openTab(event, 'tab-generator')">1. Generatore Prompt</button>
            <button class="tab-button" onclick="openTab(event, 'tab-playground')">2. Playground Anteprima</button>
        </nav>

        <div id="tab-generator" class="tab-content active">
             <div class="section">
                <h2 class="section-title">Dati per l'AI</h2>
                <p>Inserisci le informazioni base per generare lo storyboard del carosello.</p>

                <div class="form-group">
                    <label for="argomento">1. Argomento del post</label>
                    <input type="text" id="argomento" placeholder="Es. Il nuovo servizio di tracciamento pacchi">
                </div>

                <div class="form-group">
                    <label for="contenuto">2. Contenuto principale</label>
                    <textarea id="contenuto" placeholder="Incolla qui il testo sorgente, comunicati stampa, appunti, ecc..."></textarea>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Fonti e Opzioni</h2>
                
                <div class="form-group">
                    <label>3. Link a fonti esterne (opzionale)</label>
                    <div id="links-container">
                        </div>
                    <button class="btn btn-secondary" onclick="addLink()" style="margin-top: 0.5rem; background: #eee; color: #333; border: 2px solid #ddd;">+ Aggiungi Link</button>
                </div>

                <div class="form-group">
                    <label>4. Materiali aggiuntivi</label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="allegati">
                        <label for="allegati">Segnala all'AI che invierai materiali allegati (es. immagini, PDF) insieme al prompt.</label>
                    </label>
                </div>

                <div class="form-group">
                    <label for="note-aggiuntive">5. Informazioni aggiuntive (opzionale)</label>
                    <textarea id="note-aggiuntive" placeholder="Es. Enfatizzare l'aspetto della sostenibilità, target audience: giovani professionisti..." rows="3"></textarea>
                </div>
            </div>

            <div class="section">
                <button class="btn btn-primary" id="btn-genera" onclick="generatePrompt(this)">Genera Prompt</button>
                <button class="btn" id="btn-reset-generator" onclick="resetGenerator(this)" style="margin-left: 0.5rem; background: #e0e0e0; color: #333; border: 2px solid #ccc;">Reset Campi</button>
                
                <div id="prompt-output-container" style="display: none;">
                    <h2 class="section-title" style="margin-top: 2.5rem;">Prompt Generato</h2>
                    <p>Copia questo prompt e incollalo nel tuo strumento AI (es. Gemini).</p>
                    <textarea id="prompt-output" readonly></textarea>
                    <button class="btn btn-secondary" id="btn-copia" onclick="copyPrompt(this)" style="margin-top: 1rem;">Copia Prompt</button>
                </div>
            </div>
        </div>

        <div id="tab-playground" class="tab-content">
            
            <div class="playground-grid">

                <div class="playground-col-preview" id="playground-export-area">
                    <h2 class="section-title">Anteprima Carosello</h2>
                    
                    <div class="carousel-preview-container">
                        <div class="carousel-scroller" id="carousel-scroller">
                            <div class="carousel-slide" style="background-color: #eee; align-items: center; text-align: center; color: #888;">
                                <p>Incolla il JSON e clicca "Visualizza Anteprima" per generare le slide.</p>
                            </div>
                        </div>

                        <div class="carousel-nav">
                            <button class="carousel-nav-btn" id="carousel-prev" onclick="scrollCarousel(-1)" disabled>&larr;</button>
                            <span id="carousel-pager" style="align-self: center; color: var(--colore-neutro-scuro); font-weight: 600;">Slide 0 / 0</span>
                            <button class="carousel-nav-btn" id="carousel-next" onclick="scrollCarousel(1)" disabled>&rarr;</button>
                        </div>
                    </div>

                    <div class="playground-output-box">
                        <h3>Suggerimenti Visual (Modificabile)</h3>
                        <div class="playground-output-content" id="suggerimenti-output" contenteditable="true">
                            <p style="color: #888;">I suggerimenti per l'immagine della slide corrente appariranno qui...</p>
                        </div>
                    </div>

                    <input type="file" id="image-uploader" accept="image/*" style="display: none;" onchange="applyBackgroundImage(event)">
                    
                    <div class="button-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1rem;">
                        <button class="btn btn-neutral" id="btn-upload-bg" onclick="triggerImageUpload(this)">
                            Carica Sfondo
                        </button>
                        <button class="btn btn-neutral" id="btn-copy-all-text" onclick="copyAllSlideText(this)">
                            Copia Testi Slide
                        </button>
                    </div>
                </div>

                <div class="playground-col-controls">
                    <h2 class="section-title">Dati Anteprima</h2>
                    <div class="form-group">
                        <label for="json-input">Incolla o importa il JSON generato</label>
                        <textarea id="json-input" rows="10" placeholder="Incolla qui il blocco JSON restituito dall'AI o usa 'Importa JSON'..."></textarea>
                        <small id="json-error">Errore: Il JSON non è valido o ha una struttura errata.</small>
                    </div>
                    
                    <input type="file" id="json-importer" accept=".json,application/json" style="display: none;" onchange="importJSON(event)">

                    <h3 class="subsection-title">Azioni Dati</h3>
                    <div class="button-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                        <button class="btn btn-primary" id="btn-preview" onclick="renderPreview(this)" style="grid-column: 1 / -1;">Visualizza Anteprima</button>
                        <button class="btn btn-neutral" id="btn-clear-json" onclick="clearJsonInput(this)">Svuota JSON</button>
                        <button class="btn btn-neutral" id="btn-import-json" onclick="triggerImportJSON(this)">Importa JSON</button>
                        <button class="btn btn-neutral" id="btn-export-json" onclick="exportJSON(this)" style="grid-column: 1 / -1;">Esporta JSON con modifiche</button>
                    </div>
                    
                    <h3 class="subsection-title">Stile Globale (Tutte le Slide)</h3>

                    <div class="global-style-grid">
                        <label for="global-size-input">Dimensione</label>
                        <input type="range" id="global-size-input" value="1" min="0.5" max="2" step="0.05" oninput="updateGlobalStyleValue('global-size-value', this.value, 'x')">
                        <span id="global-size-value">1.00x</span>
                        
                        <label for="global-line-height-input">Interlinea</label>
                        <input type="range" id="global-line-height-input" value="1.6" min="1" max="3" step="0.1" oninput="updateGlobalStyleValue('global-line-height-value', this.value, '')">
                        <span id="global-line-height-value">1.6</span>
                        
                        <label for="global-letter-spacing-input">Spaziatura</label>
                        <input type="range" id="global-letter-spacing-input" value="0" min="-1" max="5" step="0.1" oninput="updateGlobalStyleValue('global-letter-spacing-value', this.value, 'px')">
                        <span id="global-letter-spacing-value">0.0px</span>
                    </div>
                    <button class="btn btn-secondary" id="btn-apply-global-styles" onclick="applyGlobalStyles(this)" style="width: 100%; margin-top: 0.5rem;">
                        Applica Stili Globali
                    </button>


                    <h3 class="subsection-title">Stile Locale (Slide Corrente)</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-top: -0.5rem; margin-bottom: 1rem;">Modifica la dimensione di base e il tema per questa slide.</p>
                    
                    <div class="form-group" id="local-theme-toggle-group">
                        <label class="checkbox-group">
                            <input type="checkbox" id="local-theme-toggle">
                            <label for="local-theme-toggle">Attiva Tema Negativo (Testo Chiaro)</label>
                        </label>
                    </div>

                    <div class="style-grid">
                        <label for="h1-size-input">Dimensione Titolo (h1)</label>
                        <input type="number" id="h1-size-input" value="2" min="0.5" max="5" step="0.1" title="Dimensione in rem">
                        
                        <label for="p-size-input">Dimensione Corpo (p)</label>
                        <input type="number" id="p-size-input" value="1.1" min="0.5" max="3" step="0.1" title="Dimensione in rem">
                        
                        <label for="small-size-input">Dimensione Small (small)</label>
                        <input type="number" id="small-size-input" value="0.85" min="0.5" max="2" step="0.1" title="Dimensione in rem">
                    </div>
                    <button class="btn btn-neutral" id="btn-apply-styles" onclick="applyLocalStyles(this)" style="width: 100%; margin-top: 0.5rem;">
                        Applica Stili Locali
                    </button>


                    <h3 class="subsection-title">Esporta Viste</h3>
                    <div class="button-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                        <button class="btn btn-primary" id="btn-capture-slide" onclick="showFullscreenPreview(this)" style="background-color: #4CAF50; min-width: auto;">
                            📸 Cattura Slide
                        </button>
                        <button class="btn btn-neutral" id="btn-export-pdf" onclick="exportToPDF(this)">Esporta PDF</button>
                    </div>
                    <div class="playground-output-box" style="margin-top: 2rem;">
                        <h3>Copy del Post (Modificabile)</h3>
                        <div class="playground-output-content" id="copy-post-output" contenteditable="true">
                            <p style="color: #888;">Il copy del post generato dall'AI apparirà qui...</p>
                        </div>
                    </div>

                    <div class="playground-output-box" id="riepilogo-suggerimenti-stampa" style="display: none;">
                        <h3>Riepilogo Suggerimenti Visual</h3>
                        <div class="playground-output-content" id="riepilogo-suggerimenti-output">
                            </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <div id="custom-alert-overlay" class="alert-modal-overlay">
        <div class="alert-modal-box">
            <p id="custom-alert-message">Messaggio di errore.</p>
            <button class="btn btn-primary" onclick="hideCustomAlert()">OK</button>
        </div>
    </div>
    
    <div id="capture-overlay" class="capture-overlay-container">
        <div id="capture-content" class="capture-content-wrapper">
            </div>
        <span class="capture-close-info">Clicca sullo sfondo per chiudere</span>
    </div>
    <script>
        let currentSlideIndex = 0;
        let totalSlides = 0;
        const scroller = document.getElementById('carousel-scroller');
        let suggerimentiOutput = document.getElementById('suggerimenti-output');
        
        let slideSuggerimenti = [];
        let slideBackgrounds = []; 
        let slideTextStyles = []; // Conterrà oggetti per { h1: { fontSize }, p: { fontSize }, small: { fontSize }, themeNegativo, position... }
        
        // Stato globale per stili globali (senza tema)
        let globalTextStyles = {
            multiplier: 1,
            lineHeight: 1.6,
            letterSpacing: '0px',
        };

        const pager = document.getElementById('carousel-pager');
        const btnPrev = document.getElementById('carousel-prev');
        const btnNext = document.getElementById('carousel-next');
        
        // --- GESTIONE CUSTOM ALERT ---
        function showCustomAlert(message) {
            document.getElementById('custom-alert-message').textContent = message;
            document.getElementById('custom-alert-overlay').classList.add('visible');
        }
        function hideCustomAlert() {
            document.getElementById('custom-alert-overlay').classList.remove('visible');
        }
        document.getElementById('custom-alert-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                hideCustomAlert();
            }
        });
        // --- FINE GESTIONE CUSTOM ALERT ---


        // --- INIZIO GESTIONE MODAL CATTURA ---
        const captureOverlay = document.getElementById('capture-overlay');
        const captureContent = document.getElementById('capture-content');

        // Chiude il modal cliccando sullo sfondo (overlay)
        captureOverlay.addEventListener('click', () => {
            captureOverlay.classList.remove('visible');
            captureContent.innerHTML = ''; // Svuota il contenuto
        });

        // Ferma la propagazione del click se si clicca sulla slide
        captureContent.addEventListener('click', (e) => e.stopPropagation());
        
        // --- INIZIO CORREZIONE JS (Anteprima non uguale) ---
        // Funzione per mostrare il popup di cattura
        function showFullscreenPreview(button) {
            if (totalSlides === 0) {
                showButtonFeedback(button, 'Nessuna slide');
                return;
            }
            showButtonFeedback(button, 'Apro preview...');

            // 1. Trova slide originale
            const allSlides = scroller.querySelectorAll('.carousel-slide');
            const currentSlideElement = allSlides[currentSlideIndex];
            if (!currentSlideElement) return;
            
            // 2. Clona la slide
            const slideClone = currentSlideElement.cloneNode(true);

            // 3. Trova il blocco di testo (originale e clonato)
            const originalTextBlock = currentSlideElement.querySelector('.text-overlay-block');
            const clonedTextBlock = slideClone.querySelector('.text-overlay-block');
            
            // 4. Disabilita editing sul clone per lo screenshot
            clonedTextBlock.removeAttribute('contenteditable');
            clonedTextBlock.style.cursor = 'default';
            clonedTextBlock.style.outline = 'none';

            // 5. APPLICA STILI COMPUTATI (Garantisce fedeltà 1:1)
            // Questo risolve i problemi di spaziatura e POSIZIONE
            if (originalTextBlock) {
                const originalStyles = window.getComputedStyle(originalTextBlock);
                clonedTextBlock.style.letterSpacing = originalStyles.letterSpacing;
                clonedTextBlock.style.wordSpacing = originalStyles.wordSpacing;
                clonedTextBlock.style.lineHeight = originalStyles.lineHeight;

                // CORREZIONE: Copia la posizione (se modificata col drag)
                clonedTextBlock.style.position = originalStyles.position;
                clonedTextBlock.style.top = originalStyles.top;
                clonedTextBlock.style.left = originalStyles.left;
                
                const selector = 'h1, p, small, strong, blockquote';
                const originalElements = originalTextBlock.querySelectorAll(selector);
                const clonedElements = clonedTextBlock.querySelectorAll(selector);

                // Applica stili computati da OGNI originale al SUO clone
                clonedElements.forEach((el, i) => {
                    const orig = originalElements[i];
                    if (orig) {
                        const st = window.getComputedStyle(orig);
                        el.style.letterSpacing = st.letterSpacing;
                        el.style.wordSpacing = st.wordSpacing;
                        el.style.lineHeight = st.lineHeight;
                        el.style.fontSize = st.fontSize;
                        el.style.fontFamily = st.fontFamily;
                        el.style.fontWeight = st.fontWeight;
                        el.style.color = st.color;
                        
                        // CORREZIONE: Copia margini e padding
                        // (Fondamentale per la Correzione 2)
                        el.style.margin = st.margin;
                        el.style.padding = st.padding; 
                        el.style.borderLeft = st.borderLeft; // Per blockquote
                    }
                });
            }

            // 6. Inserisci il clone nel modal e mostralo
            captureContent.innerHTML = ''; // Pulisci
            captureContent.appendChild(slideClone);
            
            captureOverlay.classList.add('visible');
        }
        // --- FINE CORREZIONE JS ---
        // --- FINE GESTIONE MODAL CATTURA ---


        // Listener per salvare le modifiche ai suggerimenti
        suggerimentiOutput.addEventListener('blur', saveSuggerimento);

        // --- GESTIONE TAB ---
        function openTab(event, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            event.currentTarget.classList.add("active");
        }

        // --- GESTIONE GENERATORE ---
        function addLink() {
            const container = document.getElementById('links-container');
            const linkItem = document.createElement('div');
            linkItem.className = 'link-item';
            linkItem.innerHTML = `
                <input type="text" class="link-input" placeholder="https://...">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(linkItem);
        }

        function showButtonFeedback(button, message, duration = 2000) {
            const originalText = button.innerHTML;
            button.innerHTML = message;
            button.disabled = true;
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, duration);
        }

        function generatePrompt(button) {
            showButtonFeedback(button, 'Generazione...');
            const argomento = document.getElementById('argomento').value;
            const contenuto = document.getElementById('contenuto').value;
            const allegati = document.getElementById('allegati').checked;
            const noteAggiuntive = document.getElementById('note-aggiuntive').value;
            const linkInputs = document.querySelectorAll('.link-input');
            const links = Array.from(linkInputs).map(input => input.value).filter(val => val.trim() !== '');

            // Prompt aggiornato
            const prompt = `
Sei un esperto social media manager e copywriter specializzato in contenuti informativi per brand istituzionali.
IL TUO COMPITO:
Crea uno storyboard dettagliato per un post carousel di Instagram (da un minimo di 3 a un massimo di 10 slide) basandoti sui seguenti dati.
DATI DI INPUT:
- Argomento: ${argomento || 'Non specificato'}
- Contenuto Principale: """
${contenuto || 'Non specificato'}
"""
${links.length > 0 ? `- Link di riferimento: \n${links.map(l => `  - ${l}`).join('\n')}` : ''}
- Presenza Materiali Allegati: ${allegati ? 'Sì' : 'No'}
- Note Aggiuntive: ${noteAggiuntive || 'Nessuna'}
REGOLE DI STILE E CONTENUTO:
1.  Tono di voce: Istituzionale, chiaro, informativo, fresco e giornalistico.
2.  Non usare la seconda persona (tu/voi). Mantenere un tono oggettivo.
3.  L'azienda autrice del post deve essere indicata in terza persona (es. "L'Azienda offre...", "Il servizio permette...").
REQUISITI DELLO STORYBOARD:
Devi produrre TRE elementi:
1.  numero_slide_consigliato: Un numero (tra 3 e 10) che ritieni ottimale.
2.  copy_post: Un testo per la caption di Instagram, scritto secondo le regole di stile.
3.  global_text_styles: Includi questo campo con valore '{}' (un oggetto vuoto).
4.  slides: Un array di oggetti, uno per ogni slide.
STRUTTURA OGGETTO SLIDE:
Ogni oggetto nell'array "slides" DEVE contenere:
-   "testo_formattato": Una stringa HTML con i testi della slide. Usa questa gerarchia:
    -   '<h1>' per il titolo della slide.
    -   '<p>' per il testo principale.
    -   '<strong>' per evidenziare termini chiave.
    -   '<blockquote>' per citazioni o dati rilevanti.
    -   '<small>' per note a piè di pagina o testi secondari.
-   "suggerimento_visual": Una breve descrizione testuale dell'immagine di sfondo.
-   "background_image": Includi questo campo con valore 'null'.
-   "text_styles": Includi questo campo con valore '{}' (un oggetto vuoto). (Conterrà 'themeNegativo: true/false' dopo la modifica manuale)
FORMATO DI OUTPUT OBBLIGATORIO:
Restituisci ESCLUSIVAMENTE un singolo blocco di codice JSON valido. Non aggiungere spiegazioni prima o dopo il JSON.
Esempio di struttura JSON:
{
  "numero_slide_consigliato": 5,
  "copy_post": "Il nuovo servizio X è ora disponibile...",
  "global_text_styles": {},
  "slides": [
    {
      "testo_formattato": "<h1>Titolo Slide 1</h1><p>Testo di introduzione...</p>",
      "suggerimento_visual": "Immagine astratta blu e gialla.",
      "background_image": null,
      "text_styles": {}
    },
    {
      "testo_formattato": "<p>Questa è una <strong>parola chiave</strong>.</p><small>Nota a piè di pagina.</small>",
      "suggerimento_visual": "Icona stilizzata che rappresenta il servizio.",
      "background_image": null,
      "text_styles": {}
    }
  ]
}
`;
            const outputContainer = document.getElementById('prompt-output-container');
            const outputTextarea = document.getElementById('prompt-output');
            outputTextarea.value = prompt.trim();
            outputContainer.style.display = 'block';
        }

        function copyPrompt(button) {
            const outputTextarea = document.getElementById('prompt-output');
            outputTextarea.select();
            outputTextarea.setSelectionRange(0, 99999);
            try {
                var successful = document.execCommand('copy');
                showButtonFeedback(button, successful ? 'Copiato!' : 'Copia fallita');
            } catch (err) {
                showButtonFeedback(button, 'Errore copia');
            }
        }

        function resetGenerator(button) {
            document.getElementById('argomento').value = '';
            document.getElementById('contenuto').value = '';
            document.getElementById('links-container').innerHTML = '';
            document.getElementById('allegati').checked = false;
            document.getElementById('note-aggiuntive').value = '';
            document.getElementById('prompt-output-container').style.display = 'none';
            document.getElementById('prompt-output').value = '';
            showButtonFeedback(button, 'Campi resettati!');
        }

        function clearJsonInput(button) {
            document.getElementById('json-input').value = '';
            showButtonFeedback(button, 'Svuotato!');
        }

        // --- GESTIONE PLAYGROUND ---

        function renderPreview(button) {
            showButtonFeedback(button, 'Caricamento...');
            let jsonInput = document.getElementById('json-input').value;
            const errorMsg = document.getElementById('json-error');
            const copyOutput = document.getElementById('copy-post-output');

            scroller.innerHTML = ''; 
            slideSuggerimenti = []; 
            slideBackgrounds = [];
            slideTextStyles = []; // Resetta gli stili

            // Resetta stato globale a default
            globalTextStyles = { multiplier: 1, lineHeight: 1.6, letterSpacing: '0px' };

            errorMsg.style.display = 'none';

            try {
                const cleanJsonInput = jsonInput.replace(/\u00A0/g, " ");
                const data = JSON.parse(cleanJsonInput);

                if (!data.slides || !Array.isArray(data.slides) || !data.copy_post) {
                    throw new Error('Struttura JSON non valida.');
                }
                
                // Carica stili globali se esistono
                if (data.global_text_styles && typeof data.global_text_styles === 'object') {
                    globalTextStyles.multiplier = data.global_text_styles.multiplier || 1;
                    globalTextStyles.lineHeight = data.global_text_styles.lineHeight || 1.6;
                    globalTextStyles.letterSpacing = data.global_text_styles.letterSpacing || '0px';
                }
                // Applica stili globali caricati
                applyGlobalStylesToDOM();
                updateGlobalStyleInputs();
                
                copyOutput.innerHTML = `<p>${data.copy_post.replace(/\n/g, '<br>')}</p>`;
                totalSlides = data.slides.length;
                if (totalSlides === 0) {
                     throw new Error('Nessuna slide trovata nel JSON.');
                }
                
                slideBackgrounds = new Array(totalSlides).fill(null);
                slideTextStyles = new Array(totalSlides).fill({}); // Inizializza come oggetti vuoti

                data.slides.forEach((slideData, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'carousel-slide';
                    
                    const textContent = document.createElement('div');
                    textContent.className = 'text-overlay-block'; 
                    textContent.setAttribute('contenteditable', 'true');
                    
                    let cleanHtml = slideData.testo_formattato || '<p>(Testo mancante)</p>';
                    textContent.innerHTML = cleanHtml.replace(/\u00A0/g, " ");

                    // Applica stili granulari salvati
                    if (slideData.text_styles) {
                        const styles = slideData.text_styles;
                        
                        if (styles.h1 && styles.h1.fontSize) {
                            textContent.style.setProperty('--local-h1-size', styles.h1.fontSize);
                        }
                        if (styles.p && styles.p.fontSize) {
                            textContent.style.setProperty('--local-p-size', styles.p.fontSize);
                        }
                        if (styles.small && styles.small.fontSize) {
                            textContent.style.setProperty('--local-small-size', styles.small.fontSize);
                        }
                        
                        // Applica stili di posizionamento
                        if (styles.position) textContent.style.position = styles.position;
                        if (styles.top) textContent.style.top = styles.top;
                        if (styles.left) textContent.style.left = styles.left;

                        // Applica tema locale
                        if (styles.themeNegativo) {
                            slide.classList.add('theme-negativo');
                        }

                        // Salva l'intero oggetto stile
                        slideTextStyles[index] = { ...styles };
                    }

                    slide.appendChild(textContent);
                    makeDraggable(textContent, index); 

                    if (slideData.background_image) {
                        slide.style.backgroundImage = `url(${slideData.background_image})`;
                        slideBackgrounds[index] = slideData.background_image; 
                    }
                    
                    scroller.appendChild(slide);
                    slideSuggerimenti.push(slideData.suggerimento_visual || '(Nessun suggerimento)');
                });

                currentSlideIndex = 0;
                updateCarouselState();
                updateRiepilogoStampa();

            } catch (e) {
                console.error("Errore parsing JSON:", e);
                errorMsg.style.display = 'block';
                copyOutput.innerHTML = '<p style="color: #888;">...</p>';
                scroller.innerHTML = `<div class="carousel-slide" style="background-color: #eee; align-items: center; text-align: center; color: var(--colore-errore);"><p><strong>Errore.</strong><br>Controlla il JSON e riprova.</p></div>`;
                totalSlides = 0;
                currentSlideIndex = 0;
                updateCarouselState();
            }
        }

        function saveSuggerimento() {
            if (totalSlides > 0 && currentSlideIndex < slideSuggerimenti.length) {
                slideSuggerimenti[currentSlideIndex] = suggerimentiOutput.innerHTML;
                updateRiepilogoStampa();
            }
        }

        function updateRiepilogoStampa() {
            const riepilogoContainer = document.getElementById('riepilogo-suggerimenti-output');
            if (totalSlides === 0) {
                riepilogoContainer.innerHTML = '';
                return;
            }
            let html = '<ul>';
            slideSuggerimenti.forEach((sugg, index) => {
                const cleanSugg = sugg.replace(/^<p>/i, '').replace(/<\/p>$/i, '');
                html += `<li style="margin-bottom: 0.75rem;"><strong>Slide ${index + 1}:</strong> ${cleanSugg}</li>`;
            });
            html += '</ul>';
            riepilogoContainer.innerHTML = html;
        }

        // Aggiorna i soli input locali
        function updateCarouselState() {
            pager.textContent = `Slide ${currentSlideIndex + 1} / ${totalSlides}`;
            btnPrev.disabled = (currentSlideIndex === 0);
            btnNext.disabled = (currentSlideIndex === totalSlides - 1 || totalSlides === 0);

            if (totalSlides > 0) {
                suggerimentiOutput.innerHTML = slideSuggerimenti[currentSlideIndex];

                // AGGIORNA CONTROLLI DI STILE LOCALI (Dimensione e Tema)
                const currentStyles = slideTextStyles[currentSlideIndex] || {};
                
                const defaults = {
                    h1: { fontSize: '2rem' },
                    p: { fontSize: '1.1rem' },
                    small: { fontSize: '0.85rem' },
                    themeNegativo: false
                };

                const h1Styles = currentStyles.h1 || defaults.h1;
                const pStyles = currentStyles.p || defaults.p;
                const smallStyles = currentStyles.small || defaults.small;

                // Popola Dimensioni
                document.getElementById('h1-size-input').value = parseFloat(h1Styles.fontSize) || parseFloat(defaults.h1.fontSize);
                document.getElementById('p-size-input').value = parseFloat(pStyles.fontSize) || parseFloat(defaults.p.fontSize);
                document.getElementById('small-size-input').value = parseFloat(smallStyles.fontSize) || parseFloat(defaults.small.fontSize);
                
                // Popola Tema Locale
                const themeNegativo = currentStyles.themeNegativo || defaults.themeNegativo;
                document.getElementById('local-theme-toggle').checked = themeNegativo;


            } else {
                 suggerimentiOutput.innerHTML = '<p style="color: #888;">...</p>';
            }
        }

        // --- NUOVE FUNZIONI STILE ---

        function updateGlobalStyleValue(elementId, value, suffix) {
            let displayValue = parseFloat(value).toFixed(suffix === 'x' ? 2 : 1);
            document.getElementById(elementId).textContent = displayValue + suffix;
        }

        function updateGlobalStyleInputs() {
            document.getElementById('global-size-input').value = globalTextStyles.multiplier;
            document.getElementById('global-line-height-input').value = globalTextStyles.lineHeight;
            document.getElementById('global-letter-spacing-input').value = parseFloat(globalTextStyles.letterSpacing);
            
            updateGlobalStyleValue('global-size-value', globalTextStyles.multiplier, 'x');
            updateGlobalStyleValue('global-line-height-value', globalTextStyles.lineHeight, '');
            updateGlobalStyleValue('global-letter-spacing-value', globalTextStyles.letterSpacing, 'px');
        }

        function applyGlobalStylesToDOM() {
            scroller.style.setProperty('--global-font-size-multiplier', globalTextStyles.multiplier);
            scroller.style.setProperty('--global-line-height', globalTextStyles.lineHeight);
            scroller.style.setProperty('--global-letter-spacing', globalTextStyles.letterSpacing);
        }

        function applyGlobalStyles(button) {
            globalTextStyles.multiplier = document.getElementById('global-size-input').value;
            globalTextStyles.lineHeight = document.getElementById('global-line-height-input').value;
            globalTextStyles.letterSpacing = document.getElementById('global-letter-spacing-input').value + 'px';
            applyGlobalStylesToDOM();
            showButtonFeedback(button, 'Stili Globali Applicati!');
        }


        // Applica stili locali
        function applyLocalStyles(button) {
            if (totalSlides === 0) {
                showButtonFeedback(button, 'Nessuna slide');
                return;
            }

            const allSlides = scroller.querySelectorAll('.carousel-slide'); // Ora prende .carousel-slide
            const currentSlideElement = allSlides[currentSlideIndex];
            if (!currentSlideElement) return;
            const currentTextBlock = currentSlideElement.querySelector('.text-overlay-block');

            // 1. Leggi i valori dagli input
            const h1Size = document.getElementById('h1-size-input').value + 'rem';
            const pSize = document.getElementById('p-size-input').value + 'rem';
            const smallSize = document.getElementById('small-size-input').value + 'rem';
            const isNegativo = document.getElementById('local-theme-toggle').checked;

            // 2. Costruisci l'oggetto stili (dimensioni + tema)
            const newStyles = {
                h1: { fontSize: h1Size },
                p: { fontSize: pSize },
                small: { fontSize: smallSize },
                themeNegativo: isNegativo
            };

            // 3. Applica gli stili come variabili CSS locali al blocco testo
            currentTextBlock.style.setProperty('--local-h1-size', h1Size);
            currentTextBlock.style.setProperty('--local-p-size', pSize);
            currentTextBlock.style.setProperty('--local-small-size', smallSize);
            
            // Applica/rimuovi classe tema alla slide
            currentSlideElement.classList.toggle('theme-negativo', isNegativo);


            // 4. Salva nello stato globale, preservando la posizione
            if (!slideTextStyles[currentSlideIndex]) {
                slideTextStyles[currentSlideIndex] = {};
            }
            // Unisci i nuovi stili di testo (h1, p, small, tema) con la posizione esistente (top, left, etc)
            Object.assign(slideTextStyles[currentSlideIndex], newStyles);

            showButtonFeedback(button, 'Stili Locali Applicati!');
        }


        function scrollCarousel(direction) {
            saveSuggerimento();
            const newIndex = currentSlideIndex + direction;
            if (newIndex < 0 || newIndex >= totalSlides) {
                return;
            }
            const scrollAmount = scroller.clientWidth * newIndex;
            scroller.scrollTo({
                left: scrollAmount,
                behavior: 'smooth'
            });
            currentSlideIndex = newIndex;
            updateCarouselState();
        }

        scroller.addEventListener('scroll', () => {
            const index = Math.round(scroller.scrollLeft / scroller.clientWidth);
            if (index !== currentSlideIndex && index < totalSlides) {
                saveSuggerimento();
                currentSlideIndex = index;
                updateCarouselState();
            }
        });
        
        // *** FUNZIONE SVG E PNG RIMOSSE ***


        function exportToPDF(button) {
            saveSuggerimento();
            showButtonFeedback(button, 'Prepara stampa...');
            
            const oldGlobalLetterSpacing = scroller.style.getPropertyValue('--global-letter-spacing');
            scroller.querySelectorAll('.text-overlay-block').forEach(el => {
                el.style.letterSpacing = 'normal';
                el.style.wordSpacing = 'normal';
            });
            scroller.style.setProperty('--global-letter-spacing', 'normal');
            
            window.print();
            
            scroller.style.setProperty('--global-letter-spacing', oldGlobalLetterSpacing);
            scroller.querySelectorAll('.text-overlay-block').forEach(el => {
                el.style.letterSpacing = ''; 
                el.style.wordSpacing = ''; 
            });
        }

        function copyAllSlideText(button) {
            const slides = document.querySelectorAll('#carousel-scroller .text-overlay-block');
            if (slides.length === 0 || totalSlides === 0) {
                showButtonFeedback(button, 'Niente da copiare');
                return;
            }
            let allText = '';
            slides.forEach((slide, index) => {
                const text = slide.textContent || slide.innerText; 
                allText += `--- SLIDE ${index + 1} ---\n`;
                allText += text.trim();
                allText += '\n\n';
            });

            const tempTextarea = document.createElement('textarea');
            tempTextarea.style.position = 'absolute';
            tempTextarea.style.left = '-9999px';
            tempTextarea.value = allText.trim();
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            tempTextarea.setSelectionRange(0, 99999);
            try {
                var successful = document.execCommand('copy');
                showButtonFeedback(button, successful ? 'Testi copiati!' : 'Copia fallita');
            } catch (err) {
                showButtonFeedback(button, 'Errore copia');
            }
            document.body.removeChild(tempTextarea);
        }

        // --- Funzioni Import/Export JSON ---
        function exportJSON(button) {
            if (totalSlides === 0) {
                showButtonFeedback(button, 'Nessun dato');
                return;
            }
            showButtonFeedback(button, 'Esportazione...');
            saveSuggerimento();

            const copyText = document.getElementById('copy-post-output').textContent || '';
            const slideElements = document.querySelectorAll('#carousel-scroller .text-overlay-block');
            const slidesData = [];

            slideElements.forEach((el, index) => {
                const cleanHtml = el.innerHTML.replace(/\u00A0/g, " ");

                slidesData.push({
                    testo_formattato: cleanHtml, 
                    suggerimento_visual: slideSuggerimenti[index] || '(Nessun suggerimento)',
                    background_image: slideBackgrounds[index] || null,
                    text_styles: slideTextStyles[index] || {} // Salva stili locali (dimensioni + posizione + tema)
                });
            });

            const exportObj = {
                numero_slide_consigliato: totalSlides,
                copy_post: copyText.trim(),
                global_text_styles: globalTextStyles, // Salva solo stili globali (no tema)
                slides: slidesData
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "storyboard_modificato.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function triggerImportJSON(button) {
            showButtonFeedback(button, 'Apri finestra...');
            document.getElementById('json-importer').click();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    document.getElementById('json-input').value = text;
                    renderPreview(document.getElementById('btn-preview'));
                } catch (err) {
                    console.error("Errore lettura file:", err);
                    document.getElementById('json-error').style.display = 'block';
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        // --- Funzioni Immagini e Posizionamento ---

        function triggerImageUpload(button) {
            if (totalSlides === 0) {
                showButtonFeedback(button, 'Crea anteprima');
                return;
            }
            document.getElementById('image-uploader').click();
        }

        function applyBackgroundImage(event) {
            const file = event.target.files[0];
            if (!file || totalSlides === 0) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataURL = e.target.result;
                const allSlides = scroller.querySelectorAll('.carousel-slide');
                const currentSlideElement = allSlides[currentSlideIndex];
                if (currentSlideElement) {
                    currentSlideElement.style.backgroundImage = `url(${dataURL})`;
                    slideBackgrounds[currentSlideIndex] = dataURL;
                }
            };
            reader.readAsDataURL(file); 
            event.target.value = null;
        }

        // Funzione per rendere il blocco trascinabile
        function makeDraggable(element, index) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                if (e.target.closest('h1, p, small, strong, blockquote')) {
                     if (e.target !== element) {
                         return;
                     }
                }
                
                e = e || window.event;
                e.preventDefault(); 
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                
                if (element.style.position !== 'absolute') {
                    const parentRect = element.parentElement.getBoundingClientRect();
                    const rect = element.getBoundingClientRect();
                    element.style.position = 'absolute';
                    element.style.top = (rect.top - parentRect.top) + 'px';
                    element.style.left = (rect.left - parentRect.left) + 'px';
                }

                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;
                
                const parent = element.parentElement;
                
                if (newTop < 0) newTop = 0;
                if (newLeft < 0) newLeft = 0;
                if (newTop + element.clientHeight > parent.clientHeight) {
                    newTop = parent.clientHeight - element.clientHeight;
                }
                if (newLeft + element.clientWidth > parent.clientWidth) {
                    newLeft = parent.clientWidth - element.clientWidth;
                }

                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;

                if (!slideTextStyles[index]) {
                    slideTextStyles[index] = {};
                }
                Object.assign(slideTextStyles[index], {
                    position: 'absolute',
                    top: element.style.top,
                    left: element.style.left
                });
            }
        }

    </script>
</body>
</html>
